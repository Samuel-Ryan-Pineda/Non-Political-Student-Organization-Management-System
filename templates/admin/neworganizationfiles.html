{% extends 'admin/adminbase.html' %}

{% block title %}New Organization Application Files{% endblock %}

{% block head_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/orgfiles.css') }}">
{% endblock %}

{% block content %}
<main class="container">
  <h2 class="org-header">New Organizations</h2>
  <hr class="divider">
  <section class="bg-white rounded-3 p-4" aria-label="New Organization Application Details">
    <div class="d-flex justify-content-between align-items-start mb-3">
      <h2 class="highlight-title fs-6 fw-semibold mb-0">New Organization Application</h2>
      <a href="{{ url_for('admin_new_organization.neworganization') }}" type="button" class="btn btn-light btn-sm d-flex align-items-center gap-1 ">
        <i class="fas fa-arrow-left"></i> Back
      </a>
    </div>
    
    <div class="org-info">
      <p class="mb-1">
        <span class="fw-semibold">Organization:</span> {{ organization.organization_name }}
      </p>
      <p class="mb-4">
        <span class="fw-semibold">Submitted On:</span> {{ application.submission_date.strftime('%B %d, %Y, %I:%M %p') if application.submission_date else 'Not submitted' }}
      </p>
    </div>

    <div class="table-responsive">
      <table class="table align-middle">
        <thead>
          <tr>
            <th scope="col" style="text-align: left;">File Name</th>
            <th scope="col" style="text-align: left;">Date and Time</th>
            <th scope="col" style="text-align: center;">Status</th>
            <th scope="col" style="text-align: center;">Action</th>
          </tr>
        </thead>
        <tbody>
          {% if application_files %}
          {% for file in application_files %}
          <tr>
            <td class="fw-semibold" style="text-align: left;">{{ file.file_name }}</td>
            <td style="text-align: left;">{{ file.submission_date.strftime('%B %d, %Y, %I:%M %p') if file.submission_date else 'Not available' }}</td>
            <td>
              {% set status_class = '' %}
              {% if file.status == 'Verified' %}
                {% set status_class = 'status-verified' %}
              {% elif file.status == 'Pending' %}
                {% set status_class = 'status-pending' %}
              {% elif file.status == 'Needs Revision' %}
                {% set status_class = 'status-needs-revision' %}
              {% elif file.status == 'Rejected' %}
                {% set status_class = 'status-rejected' %}
              {% endif %}
              <span class="status-badge {{ status_class }}">{{ file.status }}</span>
            </td>
            <td>
              <div class="action-buttons d-flex justify-content-center gap-2">
                <button type="button" class="btn admin-preview-btn btn-sm" onclick="previewFile({{ file.app_file_id }}, '{{ file.file_name }}')">
                  <i class="fas fa-eye"></i> Preview
                </button>
                
                <button type="button" class="btn btn-update btn-sm" onclick="openStatusModal({{ file.app_file_id }}, '{{ file.status }}', '{{ file.file_name }}', '{{ file.submission_date.strftime('%B %d, %Y, %I:%M %p') if file.submission_date else 'Not available' }}')">
                  Update Status
                </button>
              </div>
            </td>
          </tr>
          {% endfor %}
          {% else %}
          <tr>
            <td colspan="4" class="text-center py-4">
              <div class="alert alert-info mb-0">
                No files have been submitted for this application yet.
              </div>
            </td>
          </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </section>

  <!-- Feedback History Section -->
  <section class="feedback-history-section" aria-label="Feedback History">
    <h3 class="fw-semibold fs-6 mb-3" style="text-align: left;">FEEDBACK</h3>
    <div class="feedback-history-tabs">
      <div class="feedback-tab active">Sent Feedback <span class="feedback-count">{{ sent_feedbacks|length }}</span></div>
    </div>
    
    <!-- Feedback Content -->
    <div class="feedback-tab-content active">
      {% if sent_feedbacks %}
        {% for feedback in sent_feedbacks %}
        <div class="feedback-card sent">
          <div class="feedback-card-header">
            <div class="feedback-card-title">{{ feedback.subject }}</div>
            <div class="feedback-card-date">{{ feedback.date_sent.strftime('%B %d, %Y, %I:%M %p') if feedback.date_sent else 'Not available' }}</div>
          </div>
          <div class="feedback-card-file mb-2">
            <strong>File:</strong> {{ feedback.application_file.file_name if feedback.application_file else 'Unknown' }}
          </div>
          <div class="feedback-card-body">
            <p>{{ feedback.message }}</p>
          </div>
          <div class="d-flex justify-content-end mt-2">
            <button class="btn btn-view-feedback" onclick="editFeedback({{ feedback.feedback_id }})">Edit Feedback</button>
          </div>
        </div>
        {% endfor %}
      {% else %}
        <div class="text-center py-4">
          <div class="text-muted">
            <i class="fas fa-comment-slash fa-2x mb-2 text-secondary opacity-50"></i>
            <h6 class="text-secondary mb-1">No Feedback Sent</h6>
            <small class="text-muted">No feedback has been sent for this application yet.</small>
          </div>
        </div>
      {% endif %}
    </div>
  </section>

  <!-- Feedback Modal -->
  <div id="feedbackModal" class="global-modal" aria-labelledby="feedbackModalTitle" aria-modal="true" role="dialog">
    <div class="modal-container">
      <button type="button" class="btn-back" onclick="closeFeedbackModal()" aria-label="Close">
        <i class="fas fa-arrow-left"></i> Back
      </button>

      <div class="modal-section">
        <h2 class="form-title">Details</h2>
        <div class="form-info">
          <p><strong>Organization:</strong> Technological Advancement and Innovation Society of Future Engineers</p>
          <p><strong>File Name:</strong> <span id="file-name"></span></p>
          <p><strong>Form Type:</strong> <span id="form-type"></span></p>
          <p><strong>Form Status:</strong> <span id="form-status"></span></p>
        </div>

        <form id="feedback-form">
          <h2 class="form-title">Send a Feedback</h2>
          <div class="mb-3">
            <label for="subject" class="form-label">Subject</label>
            <input
              type="text"
              class="form-control"
              id="subject"
              name="subject"
              autocomplete="off"
            />
          </div>
          <div class="mb-4">
            <label for="message" class="form-label">Message Content</label>
            <textarea
              class="form-control"
              id="message"
              name="message"
              rows="8"
            ></textarea>
          </div>
          <div class="d-flex justify-content-end">
            <button type="submit" class="btn-send">Send Feedback</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Edit Feedback Modal -->
  <div id="editFeedbackModal" class="global-modal" aria-labelledby="editFeedbackModalTitle" aria-modal="true" role="dialog">
    <div class="modal-container">
      <button type="button" class="btn-back" onclick="closeEditFeedbackModal()" aria-label="Close">
        <i class="fas fa-arrow-left"></i> Back
      </button>

      <div class="modal-section">
        <h2 class="form-title">Edit Feedback</h2>
        <div class="form-info mb-3" style="font-size: 0.800rem">
          <p><strong>File:</strong> <span id="edit-feedback-file-name"></span></p>
        </div>
        <hr class="mb-3">
        <form id="edit-feedback-form">
          <input type="hidden" id="edit-feedback-id" name="feedback_id">
          <div class="mb-3">
            <label for="edit-feedback-subject" class="form-label" style="font-size: 0.800rem; font-weight: 600;">Subject</label>
            <input type="text" class="form-control" id="edit-feedback-subject" name="subject" required>
          </div>
          <div class="mb-4">
            <label for="edit-feedback-message" class="form-label" style="font-size: 0.800rem; font-weight: 600;">Message Content</label>
            <textarea class="form-control" id="edit-feedback-message" name="message" rows="6" required></textarea>
          </div>
          <div class="d-flex justify-content-end gap-2">
            <button type="button" class="btn btn-secondary" onclick="closeEditFeedbackModal()">Cancel</button>
            <button type="submit" class="btn-send">Update Feedback</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  
  <!-- File Preview Modal -->
  <div id="filePreviewModal" class="global-modal file-preview-modal" aria-labelledby="filePreviewModalTitle" aria-modal="true" role="dialog">
    <div class="modal-container modal-lg">
      <div class="modal-section">
        <div class="file-preview-header d-flex justify-content-between align-items-center mb-3">
          <h2 class="form-title mb-0" id="file-preview-title">File Preview</h2>
          <div class="d-flex align-items-center gap-2">
            <button type="button" class="btn btn-download" id="modal-download-btn" onclick="downloadCurrentFile()"><i class="fas fa-download"></i> Download</button>
            <button type="button" class="btn-close" onclick="closeFilePreviewModal()" aria-label="Close"></button>
          </div>
        </div>
        
        <div class="file-preview-content">
          <div id="file-preview-container" class="file-preview-container">
            <!-- File content will be loaded here -->
            <div class="text-center p-5" id="file-loading">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <p class="mt-3">Loading file preview...</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Status Update Modal -->
  <div id="statusUpdateModal" class="global-modal" aria-labelledby="statusUpdateModalTitle" aria-modal="true" role="dialog">
    <div class="modal-container">
      <button type="button" class="btn-back" onclick="closeStatusModal()" aria-label="Close">
        <i class="fas fa-arrow-left"></i> Back
      </button>

      <div class="modal-section">
        <h2 class="form-title">Update File Status</h2>
        <div class="form-info mb-3">
          <p><strong>File:</strong> <span id="status-file-name"></span></p>
          <p><strong>Submission Date:</strong> <span id="status-submission-date"></span></p>
        </div>
        <hr class="mb-3">
        <form id="status-update-form">
          <input type="hidden" id="file_id" name="file_id">
          <div class="mb-4">
            <label for="status" class="form-label">Select Status</label>
            <select class="form-control form-select" id="status" name="status" required>
              <option value="Verified">Verified</option>
              <option value="Needs Revision">Needs Revision</option>
              <option value="Rejected">Rejected</option>
            </select>
          </div>
          <div class="mb-4" id="feedback-field" style="display: none;">
            <label for="status-feedback" class="form-label">Feedback/Comments</label>
            <textarea class="form-control" id="status-feedback" name="feedback" rows="4" placeholder="Please provide feedback explaining why this file needs revision or is being rejected"></textarea>
          </div>
          <div class="d-flex justify-content-end">
            <button type="submit" class="btn-send">Update Status</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</main>

{% block extra_js %}
<!-- Common modules -->
<script src="{{ url_for('static', filename='js/common/dom-utils.js') }}?v={{ cache_version }}"></script>
<script src="{{ url_for('static', filename='js/common/file-status.js') }}?v={{ cache_version }}"></script>
<script src="{{ url_for('static', filename='js/common/file-preview.js') }}?v={{ cache_version }}"></script>
<!-- Admin-specific application script -->
<script src="{{ url_for('static', filename='js/admin/neworganizationfiles.js') }}?v={{ cache_version }}"></script>
{% endblock %}

{% endblock content %}

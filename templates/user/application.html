{% extends "user/userbase.html" %}

{% block title %}Application{% endblock %}

{% block head_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/application.css') }}?v={{ cache_version }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/updateOrgModal.css') }}?v={{ cache_version }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/loading-overlay.css') }}?v={{ cache_version }}">
{% endblock %}

{% block content %}
<div class="container">
  <h2 class="org-header">New Organization Application</h2>
  <hr class="divider">
  
  <!-- Changed class from "row" to "row info-progress-row" -->
  <div class="row info-progress-row g-3">
    <div class="col-md-4">
      <section class="card mb-3 org-card">
        <div class="card-body p-3 p-md-4 position-relative">
          {% if not application or application.status.lower() != 'verified' %}
          <div class="position-absolute" style="top: 10px; right: 10px;">
            <i class="fas fa-edit" style="cursor: pointer; color: white;" onclick="openUpdateOrgModal()" title="Update Organization Information"></i>
          </div>
          {% endif %}
          <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-center gap-3">
            <div class="mb-3 mb-md-0">
              {% if organization and organization.logo_id %}
              <img alt="Organization Logo" class="rounded-circle" height="80" width="80" src="{{ url_for('user_routes.get_logo', logo_id=organization.logo_id) }}" title="{% if organization.logo and organization.logo.description %}{{ organization.logo.description }}{% else %}{{ organization.organization_name }} Logo{% endif %}"/>
              {% else %}
              <img alt="Placeholder profile image" class="rounded-circle" height="80" width="80" src="{{ url_for('static', filename='images/placeholder-logo.png') }}?v={{ cache_version }}" title="Organization Logo"/>
              {% endif %}
            </div>
            <div>
              <p class="fw-semibold mb-1" style="font-size: 0.875rem;">ORGANIZATION</p>
              <p class="mb-2 lh-sm small">{{ organization.organization_name if organization else 'No Organization' }}</p>
              <p class="mb-0 small">
                <span class="fw-semibold">Type:</span>
                {{ organization.type if organization else 'N/A' }}
              </p>
            </div>
          </div>
        </div>
      </section>
    </div>
    <div class="col-md-8">
      <!-- Application Progress -->
      <section class="card mb-3 {% if application %}{% if application.status.lower() == 'pending' %}status-pending{% elif application.status.lower() == 'approved' %}status-approved{% elif application.status.lower() == 'rejected' %}status-rejected{% elif application.status.lower() == 'verified' %}status-verified{% else %}status-incomplete{% endif %}{% else %}status-incomplete{% endif %}">
        <div class="card-body p-3 p-md-4">
          <div class="d-flex justify-content-between align-items-start mb-3">
            <div>
              <p class="fw-semibold mb-0" style="font-size: 0.875rem;">APPLICATION PROGRESS</p>
              {% if application %}
              <p class="small text-secondary mb-1">Application Type: {{ application.type }}</p>
              <p class="fw-semibold small mb-0">Status: {{ application.status }}</p>
              {% else %}
              <p class="small text-secondary mb-1">No application data available</p>
              {% endif %}
            </div>
            <div>
              {% if application %}
                {% if application.status.lower() == 'pending' %}
                <span class="badge bg-primary">Pending</span>
                {% elif application.status.lower() == 'approved' %}
                <span class="badge bg-success">Approved</span>
                {% elif application.status.lower() == 'rejected' %}
                <span class="badge bg-danger">Rejected</span>
                {% elif application.status.lower() == 'verified' %}
                <span class="badge bg-success">Verified</span>
                {% else %}
                <span class="badge bg-secondary">{{ application.status }}</span>
                {% endif %}
              {% else %}
                <span class="badge bg-secondary">No Data</span>
              {% endif %}
            </div>
          </div>
          
          <div class="progress mb-3 progress-thin">
            {% if application %}
              {% if application.status.lower() == 'pending' %}
              <div class="progress-bar bg-primary" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%"></div>
              {% elif application.status.lower() == 'approved' %}
              <div class="progress-bar bg-success" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%"></div>
              {% elif application.status.lower() == 'rejected' %}
              <div class="progress-bar bg-danger" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%"></div>
              {% elif application.status.lower() == 'verified' %}
              <div class="progress-bar bg-success" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%"></div>
              {% else %}
              <div class="progress-bar bg-dark" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%"></div>
              {% endif %}
            {% else %}
              <div class="progress-bar bg-dark" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%"></div>
            {% endif %}
          </div>
          
          <div class="d-flex justify-content-between small text-secondary">
            <div class="d-flex align-items-center gap-1">
              <i class="fas fa-check-circle text-success"></i>
              <span>Verified: </span>
            </div>
            <div class="d-flex align-items-center gap-1">
              <i class="fas fa-clock text-primary"></i>
              <span>Pending: </span>
            </div>
            <div class="d-flex align-items-center gap-1">
              <i class="fas fa-exclamation-circle text-warning"></i>
              <span>Needs Revision: </span>
            </div>
            <div class="d-flex align-items-center gap-1">
              <i class="fas fa-times-circle text-danger"></i>
              <span>Rejected: </span>
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>
  
  <!-- Document Upload Title -->
  <div class="card mb-3 py-3 px-4">
    <div class="card-body p-0">
      <div class="d-flex justify-content-between align-items-center">
        <div class="fw-semibold">DOCUMENT UPLOAD</div>
      </div>
    </div>
  </div>
  
  {% macro document_card(title) %}
  <div class="col-12 col-md-4">
    <div class="card h-100 document-card border-0 shadow-sm">
      <div class="card-body p-3 p-md-4">
        <div class="d-flex align-items-center mb-3">
          <span class="small fw-semibold">{{ title }}</span>
          <span class="badge bg-secondary status-badge">
            <i class="fas fa-question-circle"></i> No File
          </span>
        </div>
        
        <div class="dropzone mb-3">
          <input type="file" class="file-input" accept=".pdf,.doc,.docx" style="display: none;"/>
          <i class="fas fa-cloud-upload-alt mb-1"></i>
          Drag & drop or click to upload
        </div>
        
        <div class="d-flex justify-content-between align-items-center gap-2">
          <button class="btn btn-outline-dark btn-sm" type="button">Preview</button>
          <button class="btn btn-outline-secondary btn-sm" type="button">Select File</button>
          <button class="btn btn-primary btn-sm" type="button">Upload</button>
        </div>

        <!-- Inline feedback toggle button -->
        <div class="inline-feedback-toggle" title="Click to view feedback details" role="button" aria-expanded="false" aria-controls="feedback-container" tabindex="0">
          <i class="fas fa-comment-alt" aria-hidden="true"></i> View Feedback
        </div>
        
        <!-- Inline feedback container -->
        <div class="inline-feedback-container" id="feedback-container" aria-live="polite">
          <div class="inline-feedback-card" role="region" aria-label="Feedback details">
            <div class="inline-feedback-header">
              <div class="inline-feedback-title" aria-label="Feedback subject"></div>
              <div class="inline-feedback-date" aria-label="Feedback date"></div>
            </div>
            <div class="inline-feedback-body"></div>
          </div>
          <div class="inline-feedback-close">
            <button type="button" aria-label="Close feedback">Close</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endmacro %}
  
  <!-- Document Upload Forms -->
  <div class="document-cards-container" id="documentCardsContainer">
    <div class="row g-3 mb-3 justify-content-left">
      <!-- Form 1 -->
      {{ document_card('Form 1A -APPLICATION FOR RECOGNITION') }}
      
      <!-- Form 2 -->
      {{ document_card('Form 2 - LETTER OF ACCEPTANCE') }}
      
      <!-- Form 3 -->
      {{ document_card('Form 3 - LIST OF PROGRAMS/PROJECTS/ ACTIVITIES') }}
    </div>
    
    <div class="row g-3 mb-3 justify-content-left">
      <!-- Form 4 -->
      {{ document_card('Form 4 - LIST OF MEMBERS') }}
      
      <!-- Board of Officers -->
      {{ document_card('BOARD OF OFFICERS') }}
      
      <!-- Constitution and Bylaws -->
      {{ document_card('CONSTITUTION AND BYLAWS') }}
      
      <!-- Logo with Explanation -->
      {{ document_card('LOGO WITH EXPLANATION') }}
    </div>
  </div>

  <!-- Feedback Section -->
  <section class="card mb-3">
    <div class="card-body p-3 p-md-4">
      <h3 class="fw-semibold fs-6 mb-3">FEEDBACK</h3>
      
      <div class="feedback-history-tabs">
        <div class="feedback-tab active" id="received-tab-btn">Received Feedback <span class="feedback-count" id="received-feedback-count">0</span></div>
      </div>
      
      <div class="feedback-tab-content active" id="received-tab">
        <!-- Feedback items will be dynamically loaded here -->
        <div class="text-center p-4">
          <p class="text-muted">No feedback available.</p>
        </div>
      </div>
    </div>
  </section>
</div>

<!-- Loading Modal -->
<div class="global-modal" id="loadingModal" aria-labelledby="loadingModalTitle" aria-modal="true" role="dialog">
  <div class="modal-content p-4 text-center" style="width: auto; max-width: 300px; margin: 0 auto; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
    <div class="d-flex justify-content-center">
      <div class="spinner-border text-primary mb-3" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>
    <p id="loadingMessage">Loading...</p>
  </div>
</div>

<!-- Preview Modal -->
<div class="global-modal" id="previewModal" aria-labelledby="previewModalTitle" aria-modal="true" role="dialog">
  <div id="previewModalContent" class="preview-modal-content">
    <!-- Content will be dynamically inserted here -->
  </div>
</div>

{% include 'user/modal/excelUploadModal.html' %}
{% include 'user/modal/updateorganization.html' %}

{% block extra_js %}
<!-- Common modules -->
<script src="{{ url_for('static', filename='js/common/dom-utils.js') }}?v={{ cache_version }}"></script>
<script src="{{ url_for('static', filename='js/common/file-status.js') }}?v={{ cache_version }}"></script>
<script src="{{ url_for('static', filename='js/common/file-preview.js') }}?v={{ cache_version }}"></script>
<!-- User-specific application script -->
<script src="{{ url_for('static', filename='js/user/application.js') }}?v={{ cache_version }}"></script>
<script src="{{ url_for('static', filename='js/user/modal/updateOrganizationModal.js') }}?v={{ cache_version }}"></script>
{% endblock %}

{% endblock %}
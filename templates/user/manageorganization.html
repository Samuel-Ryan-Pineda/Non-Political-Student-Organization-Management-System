{% extends 'user/userbase.html' %}

{% block title %}Organization Details{% endblock %}



{% block extra_js %}
<script>
  // Sticky header functionality
  document.addEventListener('DOMContentLoaded', function() {
    const orgHeader = document.querySelector('.organization-header');
    const stickyHeader = document.querySelector('.sticky-org-header');
    
    if (!orgHeader || !stickyHeader) {
      console.error('Could not find organization header or sticky header elements');
      return;
    }
    
    // Handle scroll event
    window.addEventListener('scroll', function() {
      // Show sticky header when the original header is about to disappear
      const headerRect = orgHeader.getBoundingClientRect();
      const headerBottom = headerRect.bottom;
      const headerHeight = headerRect.height;
      
      // Show sticky header when 75% of the original header has scrolled out of view
      if (headerBottom < headerHeight * 0.25) {
        stickyHeader.classList.add('visible');
      } else {
        stickyHeader.classList.remove('visible');
      }
    });
    
    // Trigger scroll event once to set initial state
    window.dispatchEvent(new Event('scroll'));
  });
</script>
{% endblock %}

{% block head_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/organizationdetails.css') }}?v={{ cache_version }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/organization.css') }}?v={{ cache_version }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/excelUploadModal.css') }}?v={{ cache_version }}">
<!-- Toastr CSS for toast notifications -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
<!-- Load jQuery first (required for Toastr.js) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>
<!-- Toastr JS for toast notifications - loaded after jQuery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
<script src="{{ url_for('static', filename='js/manageorganization.js') }}?v={{ cache_version }}" defer></script>
<script src="{{ url_for('static', filename='js/user/modal/editOrganizationModal.js') }}?v={{ cache_version }}" defer></script>
<script src="{{ url_for('static', filename='js/user/modal/adviserInfoModal.js') }}?v={{ cache_version }}" defer></script>
<script src="{{ url_for('static', filename='js/user/modal/socialMediaModal.js') }}?v={{ cache_version }}" defer></script>
<script src="{{ url_for('static', filename='js/user/modal/excelUploadModal.js') }}?v={{ cache_version }}" defer></script>
<style>
  table th:nth-last-child(1),
  table td:nth-last-child(1) {
    text-align: center;
  }

  /* Left align specific columns for all tables */
  /* Officers table - first 4 columns left aligned (excluding Action) */
  #officers table th:nth-child(1), #officers table td:nth-child(1), /* Position */
  #officers table th:nth-child(2), #officers table td:nth-child(2), /* Student Number */
  #officers table th:nth-child(3), #officers table td:nth-child(3), /* Name */
  #officers table th:nth-child(4), #officers table td:nth-child(4), /* Program */
  
  /* Members table - first 4 columns left aligned (excluding Action) */
  #members table th:nth-child(1), #members table td:nth-child(1), /* No. */
  #members table th:nth-child(2), #members table td:nth-child(2), /* Student Number */
  #members table th:nth-child(3), #members table td:nth-child(3), /* Name */
  #members table th:nth-child(4), #members table td:nth-child(4), /* Program */
  
  /* Volunteers table - first 4 columns left aligned (excluding Action) */
  #volunteers table th:nth-child(1), #volunteers table td:nth-child(1), /* No. */
  #volunteers table th:nth-child(2), #volunteers table td:nth-child(2), /* Student Number */
  #volunteers table th:nth-child(3), #volunteers table td:nth-child(3), /* Name */
  #volunteers table th:nth-child(4), #volunteers table td:nth-child(4), /* Program */
  
  /* Plans table - first 7 columns left aligned (excluding Status and Action) */
  #plans table th:nth-child(1), #plans table td:nth-child(1), /* No. */
  #plans table th:nth-child(2), #plans table td:nth-child(2), /* Programs/Projects/Activities */
  #plans table th:nth-child(3), #plans table td:nth-child(3), /* Objectives */
  #plans table th:nth-child(4), #plans table td:nth-child(4), /* Proposed Date */
  #plans table th:nth-child(5), #plans table td:nth-child(5), /* People Involved */
  #plans table th:nth-child(6), #plans table td:nth-child(6), /* Source of Funds */
  #plans table th:nth-child(7), #plans table td:nth-child(7) { /* Target Output */
    text-align: left !important;
  }

  .organization-header {
    position: relative;
  }
  
  /* New Edit Organization Modal Styles */
  .container-short {
    margin: 0 auto;
  }
  
  .rounded-2xl {
    border-radius: 1rem;
  }
  
  .text-gray-500 {
    color: #6b7280;
  }
  
  .text-gray-900 {
    color: #111827;
  }
  
  .border-gray-100 {
    border-color: #f3f4f6;
  }
  
  /* Optimize textarea height handling with CSS */
  textarea.field-display {
    overflow: hidden;
    min-height: 0.8rem;
    height: auto;
    box-sizing: border-box;
    width: 100%;
    transition: height 0.1s ease-in-out;
  }
  
  /* Ensure field containers have proper sizing */
  .field-container {
    width: 100%;
    position: relative;
  }
  
  .btn-upload {
    background-color: var(--button-color);
    color: white;
    border: none;
    border-radius: 0.375rem;
    padding: 0.5rem 1rem;
    font-size: 0.8rem;
    cursor: pointer;
  }
  
  .btn-upload:hover {
    background-color: var(--button-hover);
  }
  
  .btn-edit {
    background-color: transparent;
    color: #6b7280;
    border: 1px solid #d1d5db;
    border-radius: 0.375rem;
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
    cursor: pointer;
  }
  
  .btn-edit:hover {
    background-color: #f3f4f6;
  }
</style>
{% endblock %}

{% block additional_content %}
    <!-- Hidden organization ID field for JavaScript use -->
    <input type="hidden" id="organization-id" value="{{ organization.organization_id }}">
    
    <!-- Sticky header that appears when scrolling -->
    <div class="sticky-org-header">
        {% if organization.logo_id %}
        <img src="{{ url_for('user_organization.get_logo', logo_id=organization.logo_id) }}" alt="{{ organization.organization_name }} logo" class="sticky-org-logo">
        {% else %}
        <img src="https://placehold.co/40x40/png/ffffff/000000?text=Logo" alt="Organization logo" class="sticky-org-logo">
        {% endif %}
        <div class="sticky-org-info">
            <h3 class="sticky-org-title">{{ organization.organization_name }}</h3>
            {% if organization.type %}
            <p class="sticky-org-type">{{ organization.type }}</p>
            {% endif %}
        </div>
    </div>
    
    <section class="organization-header org-card">
        <div class="d-flex justify-content-center align-items-center">
            <div class="d-flex flex-column flex-sm-row gap-5 align-items-center justify-content-center">
                {% if organization.logo_id %}
                <img src="{{ url_for('user_organization.get_logo', logo_id=organization.logo_id) }}" alt="{{ organization.organization_name }} logo" title="{% if organization.logo.description %}{{ organization.logo.description }}{% else %}{{ organization.organization_name }} - {{ organization.type if organization.type else 'Organization' }} Logo{% endif %}" class="org-logo">
                {% else %}
                <img src="https://placehold.co/120x120/png/ffffff/000000?text=Logo" alt="Organization logo" title="Organization Logo - Click Edit Organization to upload a custom logo" class="org-logo">
                {% endif %}
                <div class="flex-grow-1 text-start">
                    <h2 class="org-title">{{ organization.organization_name }}</h2>
                    {% if organization.type %}
                    <p class="org-type"><strong>Type:</strong> {{ organization.type }}</p>
                    {% endif %}
                    {% if organization.tagline %}
                    <p class="org-quote">"{{ organization.tagline }}"</p>
                    {% endif %}
                    {% if organization.description %}
                    <p class="org-description">{{ organization.description }}</p>
                    {% endif %}
                    {% if adviser %}
                    <p class="org-adviser">{{ adviser.type if adviser.type else 'Adviser' }}: {{ adviser.full_name }}</p>
                    {% endif %}
                    {% if coadviser %}
                    <p class="org-adviser">{{ coadviser.type if coadviser.type else 'Co-Adviser' }}: {{ coadviser.full_name }}</p>
                    {% endif %}

                   <!-- Social Media & Organization Management Row -->
                    <div class="d-flex justify-content-between align-items-center flex-wrap mt-3">
                        <!-- Left Side: Buttons -->
                        <div class="my-auto gap-2">
                            <button type="button" class="btn btn-primary me-2 mb-2" style="font-size: 0.8rem;" onclick="showEditOrganizationProfileModal()">
                                Edit Organization
                            </button>
                            <button type="button" class="btn btn-secondary my-auto me-2 mb-2" style="font-size: 0.8rem;" onclick="showAdviserInfoModal()">
                                Adviser Info
                            </button>
                            <i class="fas fa-link my-auto" style="font-size: 1.5rem; color: white; cursor: pointer;" onclick="showSocialMediaModal()" title="Social Media Links"></i>
                        </div>

                        <!-- Right Side: Social Media Logos -->
                        <div class="org-social">
                            {% if social_media %}
                            <div class="d-flex gap-2">
                                {% for sm in social_media %}
                                <a href="{{ sm.link }}" target="_blank" title="{{ sm.platform }}">
                                    {% if sm.platform.lower() == 'facebook' %}
                                    <i class="fab fa-facebook" style="font-size: 1.5rem; color: #fff;"></i>
                                    {% elif sm.platform.lower() == 'twitter' %}
                                    <i class="fab fa-twitter" style="font-size: 1.5rem; color: #fff;"></i>
                                    {% elif sm.platform.lower() == 'instagram' %}
                                    <i class="fab fa-instagram" style="font-size: 1.5rem; color: #fff;"></i>
                                    {% elif sm.platform.lower() == 'messenger' %}
                                    <i class="fab fa-facebook-messenger" style="font-size: 1.5rem; color: #fff;"></i>
                                    {% else %}
                                    <i class="fas fa-link" style="font-size: 1.5rem; color: #fff;"></i>
                                    {% endif %}
                                </a>
                                {% endfor %}
                            </div>
                            {% else %}
                            <div class="d-flex gap-2"></div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
{% endblock %}

{% block content %}
<div class="container">
    <section class="stats-container">
        <div class="stat-card stat-members">
            <div>No. of Members</div>
            <div class="d-flex align-items-center fw-semibold fs-4">
                <i class="fas fa-users stat-icon"></i> {{ statistics.member_count }}
            </div>
        </div>
        
        <div class="stat-card stat-volunteers">
            <div>No. of Volunteers</div>
            <div class="d-flex align-items-center fw-semibold fs-4">
                <i class="fas fa-hand-holding-heart stat-icon"></i> {{ statistics.volunteer_count }}
            </div>
        </div>
        
        <div class="stat-card stat-activities">
            <div>Accomplished Activities</div>
            <div class="d-flex align-items-center fw-semibold fs-4">
                <i class="fas fa-tasks stat-icon"></i> {{ statistics.accomplished_activities }}
            </div>
        </div>
        
        <div class="stat-card stat-status">
            <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                Organization Status
                <span class="status-active">{{ statistics.organization_status }}</span>
            </div>
        </div>
    </section>

    <section class="import-section">
        <div class="card">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-12 col-sm-3">
                        <h4 class="mb-0">Data Import</h4>
                    </div>
                    <div class="col-12 col-sm-6 my-2 my-sm-0">
                        <p class="mb-0">Quickly upload officers, members, and volunteers in bulk using Excel import.</p>
                    </div>
                    <div class="col-12 col-sm-3 text-sm-end text-start">
                        <button type="button" class="btn btn-success" style="background-color: #28a745; font-size: 0.75rem; padding: 0.25rem 0.5rem;" onclick="showExcelUploadModal()">
                            Import Excel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Academic Year Selector -->
    <section class="academic-year-section" style="margin-bottom: 1rem;">
        <div class="d-flex justify-content-end align-items-center gap-3" style="padding: 0.5rem 0;">
            <label for="academicYearSelect" class="form-label mb-0" style="font-size: 0.875rem;">View data for:</label>
            <select class="form-select" id="academicYearSelect" onchange="changeAcademicYear()" style="width: auto; font-size: 0.875rem;">
                {% for year in available_years %}
                <option value="{{ year }}" {% if year == selected_academic_year %}selected{% endif %}>
                    {{ year }}
                </option>
                {% endfor %}
            </select>
        </div>
    </section>

    <!-- Tabbed interface for organization data -->
    <section class="tabs-container">
        <ul class="nav nav-tabs" id="organizationTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="officers-tab" data-bs-toggle="tab" data-bs-target="#officers" type="button" role="tab" aria-controls="officers" aria-selected="true">
                    Board of Officers
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="members-tab" data-bs-toggle="tab" data-bs-target="#members" type="button" role="tab" aria-controls="members" aria-selected="false">
                    Members
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="volunteers-tab" data-bs-toggle="tab" data-bs-target="#volunteers" type="button" role="tab" aria-controls="volunteers" aria-selected="false">
                    Volunteers
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="plans-tab" data-bs-toggle="tab" data-bs-target="#plans" type="button" role="tab" aria-controls="plans" aria-selected="false">
                    Plans
                </button>
            </li>
        </ul>
        
        <div class="tab-content" id="organizationTabsContent">
            <!-- Board of Officers Tab -->
            <div class="tab-pane fade show active" id="officers" role="tabpanel" aria-labelledby="officers-tab">
                <section class="table-container">
                    <div class="table-scroll">
                        <table>
                            <thead>
                                <tr>
                                    <th style="width:15%;">Position</th>
                                    <th style="width:15%;">Student Number</th>
                                    <th style="width:30%;">Name</th>
                                    <th style="width:25%;">Program</th>
                                    <th style="width:15%;">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if officers %}
                                {% for officer in officers %}
                                <tr>
                                    <td>{{ officer.position }}</td>
                                    <td>{{ officer.student_no }}</td>
                                    <td>{{ officer.name }}</td>
                                    <td>{{ officer.program }}</td>
                                    <td>
                                        <button type="button" class="btn btn-primary btn-sm" onclick="showEditOfficerModal('{{ officer.affiliation_id }}', '{{ officer.student_id }}', '{{ officer.position }}', '{{ officer.student_no }}', '{{ officer.program }}')">
                                            <i class="fas fa-edit"></i> Update
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                                {% else %}
                                <tr>
                                    <td colspan="5" class="text-center py-3">No officers added yet. Use the Excel upload feature to import officers.</td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </section>
            </div>
            
            <!-- Members Tab -->
            <div class="tab-pane fade" id="members" role="tabpanel" aria-labelledby="members-tab">
                <section class="table-container">
                    <div class="table-scroll">
                        <table>
                            <thead>
                                <tr>
                                    <th style="width:8%;">No.</th>
                                    <th style="width:20%;">Student Number</th>
                                    <th style="width:37%;">Name</th>
                                    <th style="width:20%;">Program</th>
                                    <th style="width:15%;">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if members|default([]) %}
                                    {% for member in members %}
                                    <tr>
                                        <td>{{ loop.index }}</td>
                                        <td>{{ member.student_no }}</td>
                                        <td>{{ member.name }}</td>
                                        <td>{{ member.program }}</td>
                                        <td>
                                            <button type="button" class="btn btn-primary btn-sm" onclick="showEditMemberModal('{{ member.affiliation_id }}', '{{ member.student_id }}', '{{ member.student_no }}', '{{ member.name }}', '{{ member.program }}')">
                                                <i class="fas fa-edit"></i> Update
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="5" class="text-center py-3">No members added yet. Use the Excel upload feature to import members.</td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </section>
            </div>
            
            <!-- Volunteers Tab -->
            <div class="tab-pane fade" id="volunteers" role="tabpanel" aria-labelledby="volunteers-tab">
                <section class="table-container">
                    <div class="table-scroll">
                        <table>
                            <thead>
                                <tr>
                                    <th style="width:8%;">No.</th>
                                    <th style="width:20%;">Student Number</th>
                                    <th style="width:37%;">Name</th>
                                    <th style="width:20%;">Program</th>
                                    <th style="width:15%;">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if volunteers|default([]) %}
                                    {% for volunteer in volunteers %}
                                    <tr>
                                        <td>{{ loop.index }}</td>
                                        <td>{{ volunteer.student_no }}</td>
                                        <td>{{ volunteer.name }}</td>
                                        <td>{{ volunteer.program }}</td>
                                        <td>
                                            <button type="button" class="btn btn-primary btn-sm" onclick="showEditVolunteerModal('{{ volunteer.affiliation_id }}', '{{ volunteer.student_id }}', '{{ volunteer.student_no }}', '{{ volunteer.name }}', '{{ volunteer.program }}')">
                                                <i class="fas fa-edit"></i> Update
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="5" class="text-center py-3">No volunteers added yet. Use the Excel upload feature to import volunteers.</td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </section>
            </div>
            
            <!-- Plans Tab -->
            <div class="tab-pane fade" id="plans" role="tabpanel" aria-labelledby="plans-tab">
                <section class="table-container">
                    <div class="table-scroll">
                        <table>
                            <thead>
                                <tr>
                                    <th style="width:4%;">No.</th>
                                    <th style="width:18%;">Programs/Projects/Activities</th>
                                    <th style="width:23%;">Objectives</th>
                                    <th style="width:10%;">Proposed Date</th>
                                    <th style="width:13%;">People Involved</th>
                                    <th style="width:10%;">Source of Funds</th>
                                    <th style="width:10%;">Target Output</th>
                                    <th style="width:7%;">Status</th>
                                    <th style="width:5%;">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if plans|default([]) %}
                                    {% for plan in plans %}
                                    <tr>
                                        <td>{{ loop.index }}</td>
                                        <td>{{ plan.title }}</td>
                                        <td>{{ plan.objectives }}</td>
                                        <td>{{ plan.proposed_date }}</td>
                                        <td>{{ plan.people_involved }}</td>
                                        <td>{{ plan.funding_source }}</td>
                                        <td>{{ plan.target_output }}</td>
                                        <td class="outcome-{% if plan.outcome == 'Accomplished' %}accomplished{% elif plan.outcome == 'Failed to Accomplish' %}failed{% else %}pending{% endif %}">
                            {{ plan.outcome or 'Pending' }}
                        </td>
                        <td>
                            <button type="button" class="btn btn-primary btn-sm" onclick="showEditPlanModal('{{ plan.plan_id }}', '{{ plan.title }}', '{{ plan.objectives }}', '{{ plan.proposed_date }}', '{{ plan.people_involved }}', '{{ plan.funding_source }}', '{{ plan.target_output }}', '{{ plan.outcome or "Pending" }}')">
                                <i class="fas fa-edit"></i> Update
                            </button>
                        </td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="9" class="text-center py-3">No plans added yet. Click the "Add Plan" button to add organization plans.</td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                    <div class="d-flex justify-content-end mb-2 mt-3">
                        <button type="button" class="btn btn-primary" style="background-color: #0D3B44;" onclick="showAddPlanModal()">
                            <i class="fas fa-plus"></i> Add Plan
                        </button>
                    </div>
                </section>
            </div>
        </div>
    </section>
</div>


<!-- Include Organization Profile Editor -->
{% include 'user/modal/editOrganizationModal.html' %}
{% include 'user/modal/adviserInfoModal.html' %}
{% include 'user/modal/socialmedialinks.html' %}
{% include 'user/modal/excelUploadModal.html' %}

<!-- Include Unified Edit Student Modal (Officers, Members, Volunteers) -->
{% include 'user/modal/editstudentmodal.html' %}

<!-- Include Edit Plan Modal -->
{% include 'user/modal/editplanmodal.html' %}
{% endblock %}
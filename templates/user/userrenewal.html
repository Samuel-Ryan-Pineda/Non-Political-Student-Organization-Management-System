{% extends "user/userbase.html" %}

{% block title %}Renewal{% endblock %}

{% block head_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/application.css') }}?v={{ cache_version }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/loading-overlay.css') }}?v={{ cache_version }}">
<style>
  /* Additional styles specific to renewal page */
  .card-body, .container, p, span, h1, div:not(.dropzone div) { text-align: left !important; }
  
  .dropzone, .dropzone div { text-align: center !important; }
  
  /* Ensure dropzone content is centered */
  .dropzone {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }
  
  .fw-semibold.fs-6, .fw-semibold.small, .small.fw-semibold {
    color: #0D3B44;
    font-size: 0.75em;
  }
  
  /* Progress and UI elements */
  .progress-bar { background-color: #0D3B44 !important; }
  
  .progress-thin { height: 8px; }
  
  /* Document card styles */
  .document-card {
    transition: all 0.3s ease;
    flex: 1 0 0;
    min-width: 0;
  }
  
  /* Removed hover effect that made cards rise up */
  .document-card:hover {
    /* No transform or box-shadow */
  }
  
  .row.g-3 {
    display: flex;
    flex-wrap: wrap;
  }
  
  .row.g-3 > [class*="col-"] {
    display: flex;
  }
  
  /* Feedback Section Styles */
  .feedback-history-tabs {
    display: flex;
    border-bottom: 1px solid #e5e7eb;
    margin-bottom: 1rem;
  }
  
  .feedback-tab {
    padding: 0.5rem 1rem;
    cursor: pointer;
    border-bottom: 2px solid transparent;
    font-weight: 500;
    color: #6b7280;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  
  .feedback-tab.active {
    color: #1d4ed8;
    border-bottom-color: #1d4ed8;
  }
  
  .feedback-count {
    background-color: #e5e7eb;
    color: #4b5563;
    font-size: 0.75rem;
    padding: 0.125rem 0.375rem;
    border-radius: 9999px;
  }
  
  .feedback-card {
    border: 1px solid #e5e7eb;
    border-radius: 0.5rem;
    padding: 1rem;
    margin-bottom: 1rem;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    transition: all 0.3s ease;
  }
  
  .feedback-card:hover {
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
  }
  
  .feedback-card.unread {
    border-left: 4px solid #1d4ed8;
    background-color: rgba(29, 78, 216, 0.05);
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
  }
  
  .feedback-card.unread .feedback-card-header {
    font-weight: bold;
  }
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
  }
  
  .feedback-card.unread {
    border-left: 4px solid #1d4ed8;
    background-color: rgba(29, 78, 216, 0.05);
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
  }
  
  .feedback-card.unread .feedback-card-header {
    font-weight: bold;
  }
  
  .feedback-card-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.5rem;
  }
  
  .feedback-card-title {
    font-weight: 600;
    color: #1f2937;
  }
  
  .feedback-card-date {
    color: #6b7280;
    font-size: 0.75rem;
  }
  
  .feedback-card-body {
    color: #4b5563;
    margin-bottom: 0.5rem;
  }
  
  .feedback-card-file {
    font-size: 0.75rem;
    color: #6b7280;
    background-color: #f3f4f6;
    padding: 0.5rem;
    border-radius: 0.25rem;
  }
  
  .feedback-tab-content {
    display: none;
  }
  
  .feedback-tab-content.active {
    display: block;
  }
  
  @media (max-width: 767.98px) {
    .status-badge {
      font-size: 0.625rem;
    }
  }
  
  /* Equal height for info and progress cards */
  .info-progress-row {
    display: flex;
    flex-wrap: wrap;
  }
  
  .info-progress-row > [class*="col-"] {
    display: flex;
  }
  
  .info-progress-row .card {
    width: 100%;
    display: flex;
    flex-direction: column;
  }
  
  .info-progress-row .card-body {
    flex: 1;
    display: flex;
    flex-direction: column;
  }
  
  /* Added specific heights for smaller screens */
  @media (max-width: 767.98px) {
    .info-progress-row .card {
      margin-bottom: 1rem;
    }
  }
  
  /* Modal styles to match application.html */
  .modal-container {
    background: white;
    padding: 2rem;
    border-radius: 0.5rem;
    width: 90%;
    max-width: 500px;
    margin-top: 1vh;
    margin-bottom: 1vh;
  }
  
  .global-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    display: none;
    z-index: 1050;
    justify-content: center;
    align-items: flex-start;
    overflow-y: auto;
    padding: 20px 0;
  }
</style>
{% endblock %}

{% block content %}
<div class="container">
  <h2 class="org-header">Organization Renewal</h2>
  <hr class="divider">
  
  <!-- Changed class from "row" to "row info-progress-row" -->
  <div class="row info-progress-row g-3">
    <div class="col-md-4">
      <section class="card mb-3 org-card">
        <div class="card-body p-3 p-md-4 position-relative">
          <!-- Edit functionality removed as per requirements -->
          <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-center gap-3">
            <div class="mb-3 mb-md-0">
              {% if organization and organization.logo_id %}
              <img alt="Organization Logo" class="rounded-circle" height="80" width="80" src="{{ url_for('user_organization.get_logo', logo_id=organization.logo_id) }}" title="{% if organization.logo and organization.logo.description %}{{ organization.logo.description }}{% else %}{{ organization.organization_name }} Logo{% endif %}"/>
              {% else %}
              <img alt="Placeholder profile image" class="rounded-circle" height="80" width="80" src="{{ url_for('static', filename='images/placeholder-logo.png') }}?v={{ cache_version }}" title="Organization Logo"/>
              {% endif %}
            </div>
            <div>
              <p class="fw-semibold mb-1" style="font-size: 0.875rem;">ORGANIZATION</p>
              <p class="mb-2 lh-sm small">{{ organization.organization_name if organization else 'No Organization' }}</p>
              <p class="mb-0 small">
                <span class="fw-semibold">Type:</span>
                {{ organization.type if organization else 'N/A' }}
              </p>
            </div>
          </div>
        </div>
      </section>
    </div>
    <div class="col-md-8">
      <!-- Renewal Progress -->
      <section class="card mb-3 status-incomplete">
        <div class="card-body p-3 p-md-4">
          <!-- Hidden input to store application status from backend -->
          <input type="hidden" id="applicationStatus" value="{{ application.status if application and application.status else 'Incomplete' }}">
          
          <div class="d-flex justify-content-between align-items-start mb-3">
            <div>
              <p class="fw-semibold mb-0" style="font-size: 0.875rem;">RENEWAL PROGRESS</p>
              <p class="small text-secondary mb-1">{{ "Application is under review" if application and application.status == "Pending" else 
                                                  "All files verified" if application and application.status == "Verified" else 
                                                  "Some files need attention" if application and application.status == "Rejected" else 
                                                  "Some files need revision" if application and application.status == "Needs Revision" else 
                                                  "Please upload all required files" if application and application.status == "Incomplete" else 
                                                  "No renewal data available" }}</p>
            </div>
            <div>
              <span class="badge {{ "bg-success" if application and application.status == "Verified" else 
                                  "bg-danger" if application and application.status == "Rejected" else 
                                  "bg-warning" if application and application.status == "Needs Revision" else 
                                  "bg-primary" if application and application.status == "Pending" else 
                                  "bg-secondary" }}">{{ "Complete" if application and application.status == "Verified" else 
                                                      application.status if application and application.status else "No Data" }}</span>
            </div>
          </div>
          
          <div class="progress mb-3 progress-thin">
            <div class="progress-bar bg-dark" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%"></div>
          </div>
          
          <div class="d-flex justify-content-between small text-secondary">
            <div class="d-flex align-items-center gap-1">
              <i class="fas fa-check-circle text-success"></i>
              <span>Verified: 0</span>
            </div>
            <div class="d-flex align-items-center gap-1">
              <i class="fas fa-clock text-primary"></i>
              <span>Pending: 0</span>
            </div>
            <div class="d-flex align-items-center gap-1">
              <i class="fas fa-exclamation-circle text-warning"></i>
              <span>Needs Revision: 0</span>
            </div>
            <div class="d-flex align-items-center gap-1">
              <i class="fas fa-times-circle text-danger"></i>
              <span>Rejected: 0</span>
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>
  
  <!-- Document Upload Title -->
  <div class="card mb-3 py-3 px-4">
    <div class="card-body p-0">
      <div class="d-flex justify-content-between align-items-center">
        <div class="fw-semibold">DOCUMENT UPLOAD</div>
      </div>
    </div>
  </div>
  
  <!-- Document Cards Container -->
  <div class="document-cards-container" id="documentCardsContainer">
  
  {% macro document_card(title, status='No File', status_class='bg-secondary', status_icon='fa-question-circle') %}
  <div class="col-12 col-md-4">
    <div class="card h-100 document-card border-0 shadow-sm">
      <div class="card-body p-3 p-md-4">
        <div class="d-flex align-items-center mb-3">
          <span class="small fw-semibold">{{ title }}</span>
          <span class="badge {{ status_class }} status-badge">
            <i class="fas {{ status_icon }}"></i> {{ status }}
          </span>
        </div>
        
        <div class="dropzone mb-3">
          <input type="file" class="file-input" accept=".pdf" style="display: none;"/>
          <i class="fas fa-cloud-upload-alt mb-1"></i>
          Drag & drop or click to upload
        </div>
        
        <div class="d-flex justify-content-between align-items-center gap-2">
          <button class="btn btn-outline-dark btn-sm preview-btn" type="button">Preview</button>
          <button class="btn btn-outline-secondary btn-sm select-btn" type="button">Select File</button>
          <button class="btn btn-primary btn-sm upload-btn" type="button">Upload</button>
        </div>
        
        <!-- Inline feedback toggle button -->
        <div class="inline-feedback-toggle" title="Click to view feedback details" role="button" aria-expanded="false" aria-controls="feedback-container" tabindex="0">
          <i class="fas fa-comment-alt" aria-hidden="true"></i> View Feedback
        </div>
        
        <!-- Inline feedback container -->
        <div class="inline-feedback-container" id="feedback-container" aria-live="polite">
          <div class="inline-feedback-card" role="region" aria-label="Feedback details">
            <div class="inline-feedback-header">
              <div class="inline-feedback-title" aria-label="Feedback subject"></div>
              <div class="inline-feedback-date" aria-label="Feedback date"></div>
            </div>
            <div class="inline-feedback-body"></div>
          </div>
          <div class="inline-feedback-close">
            <button type="button" aria-label="Close feedback">Close</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endmacro %}
  
  <!-- Document Upload Forms -->
  <div class="row g-3 mb-3 justify-content-left">
    <!-- Form 1 -->
    {{ document_card('Form 1B - APPLICATION FOR RENEWAL OF RECOGNITION', 'No File', 'bg-secondary', 'fa-question-circle') }}
    
    <!-- Form 2 -->
    {{ document_card('Form 2 - LETTER OF ACCEPTANCE', 'No File', 'bg-secondary', 'fa-question-circle') }}
    
    <!-- Form 3 -->
    {{ document_card('Form 3 - LIST OF PROGRAMS/PROJECTS/ ACTIVITIES', 'No File', 'bg-secondary', 'fa-question-circle') }}
  </div>
  
  <div class="row g-3 mb-3 justify-content-left">
    <!-- Form 4 -->
    {{ document_card('Form 4 - LIST OF MEMBERS', 'No File', 'bg-secondary', 'fa-question-circle') }}
    
    <!-- Board of Officers -->
    {{ document_card('BOARD OF OFFICERS', 'No File', 'bg-secondary', 'fa-question-circle') }}
    
    <!-- Updated Constitution and Bylaws -->
    {{ document_card('UPDATED CONSTITUTION AND BYLAWS', 'No File', 'bg-secondary', 'fa-question-circle') }}
    
    <!-- Accomplishment Report -->
    {{ document_card('ACCOMPLISHMENT REPORT AND DOCUMENTATION', 'No File', 'bg-secondary', 'fa-question-circle') }}
    
    <!-- Financial Statement -->
    {{ document_card('FINANCIAL STATEMENT OF THE PREVIOUS ACADEMIC YEAR', 'No File', 'bg-secondary', 'fa-question-circle') }}
    
    <!-- Logo with Explanation -->
    {{ document_card('LOGO WITH EXPLANATION', 'No File', 'bg-secondary', 'fa-question-circle') }}
  </div>
  </div>

  <!-- Feedback Section -->
  <section class="card mb-3">
    <div class="card-body p-3 p-md-4">
      <h3 class="fw-semibold fs-6 mb-3">FEEDBACK</h3>
      
      <div class="feedback-history-tabs">
        <div class="feedback-tab active" id="received-tab-btn">Received Feedback <span class="feedback-count" id="received-feedback-count">0</span></div>
      </div>
      
      <div class="feedback-tab-content active" id="received-tab">
        <!-- Empty feedback state -->
        <div class="text-center p-4">
          <p class="text-muted">No feedback available.</p>
        </div>
      </div>
    </div>
  </section>
</div>

<!-- Loading Modal -->
<div class="global-modal" id="loadingModal" aria-labelledby="loadingModalTitle" aria-modal="true" role="dialog">
  <div class="modal-content p-4 text-center" style="width: auto; max-width: 300px; margin: 0 auto; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
    <div class="d-flex justify-content-center">
      <div class="spinner-border text-primary mb-3" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>
    <p id="loadingMessage">Loading...</p>
  </div>
</div>

<!-- Preview Modal -->
<div class="global-modal" id="previewModal" aria-labelledby="previewModalTitle" aria-modal="true" role="dialog">
  <div id="previewModalContent" class="preview-modal-content">
    <!-- Content will be dynamically inserted here -->
  </div>
</div>

{% include 'user/modal/excelUploadModal.html' %}

{% block extra_js %}
<!-- Common modules -->
<script src="{{ url_for('static', filename='js/common/dom-utils.js') }}?v={{ cache_version }}"></script>
<script src="{{ url_for('static', filename='js/common/file-status.js') }}?v={{ cache_version }}"></script>
<script src="{{ url_for('static', filename='js/common/file-preview.js') }}?v={{ cache_version }}"></script>
<!-- User-specific renewal script with disabled functionality -->
<script src="{{ url_for('static', filename='js/user/renewal.js') }}?v={{ cache_version }}"></script>
{% endblock %}

<!-- Organization update functionality removed from renewal page -->
{% endblock %}
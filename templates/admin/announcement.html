{% extends 'admin/adminbase.html' %}

{% block title %}Student Organization Announcement{% endblock %}

{% block head_css %}
<link href="https://fonts.googleapis.com/css2?family=Inter&display=swap" rel="stylesheet">
<link rel="stylesheet" href="{{ url_for('static', filename='css/announcement.css') }}?v={{ cache_version }}">
{% endblock %}

{% block additional_content %}
<!-- Header Block -->
<div class="header-block">
  <div class="header-content">
    <h1 class="header-title">
      Student Organization Announcement
    </h1>
    <p class="header-subtitle">
      Create and send announcements to student organizations
    </p>
  </div>
</div>
{% endblock %}

{% block content %}
<div class="container">

  <div class="container container-custom">
    <div class="d-flex mb-0">
      <button type="button" id="tab-create" class="tab-btn create-announcement active">Create Announcement</button>
      <button type="button" id="tab-history" class="tab-btn sent-history">Sent History</button>
    </div>
    
    <!-- Create Announcement Tab Content -->
    <div class="email-container" id="create-content">
      <form id="announcement-form" class="px-3 pt-3 pb-4" action="{{ url_for('announcement.send_announcement') }}" method="POST">
        <!-- Organization Selection -->
        <div class="mb-3">
          <label for="organizations" class="form-label" style="font-size: 0.75rem;">Send to Organizations:</label>
          <select id="organizations" class="organization-select" multiple>
            <option value="all">All Organizations</option>
            {% if organizations %}
              {% for org in organizations %}
                <option value="{{ org.organization_id }}">{{ org.organization_name }}</option>
              {% endfor %}
            {% endif %}
          </select>
          <div class="mt-2">
            <button type="button" id="view-recipients-btn" class="btn-view-recipients hidden" onclick="openRecipientsModal()">
              View Recipients List
            </button>
            <p class="instruction-text mb-0 text-end" style="font-size: 0.65rem; color: #6b7280;">Hold Ctrl and click to select multiple organizations</p>
          </div>
        </div>
        
        <!-- Subject Field -->
        <div class="mb-3">
          <label for="subject" class="form-label">Subject:</label>
          <input type="text" id="subject" class="subject-input" placeholder="Enter subject" />
        </div>
        
        <!-- Message Field -->
        <div class="mb-3">
          <label for="message" class="form-label">Message:</label>
          <div class="toolbar">
            <button type="button" id="bold-btn" aria-label="Bold" title="Bold"><b>B</b></button>
            <button type="button" id="italic-btn" aria-label="Italic" title="Italic"><i>I</i></button>
            <button type="button" id="underline-btn" aria-label="Underline" title="Underline"><u>U</u></button>
            <div class="toolbar-separator"></div>
            <button type="button" id="align-left-btn" aria-label="Align Left" title="Align Left" class="active">
              <i class="fas fa-align-left"></i>
            </button>
            <button type="button" id="align-center-btn" aria-label="Align Center" title="Align Center">
              <i class="fas fa-align-center"></i>
            </button>
            <button type="button" id="align-right-btn" aria-label="Align Right" title="Align Right">
              <i class="fas fa-align-right"></i>
            </button>
            <button type="button" id="align-justify-btn" aria-label="Justify" title="Justify">
              <i class="fas fa-align-justify"></i>
            </button>
            <div class="toolbar-separator"></div>
            <button type="button" id="bullet-list-btn" aria-label="Bullet list" title="Bullet List">
              <i class="fas fa-list-ul"></i>
            </button>
            <button type="button" id="numbered-list-btn" aria-label="Numbered list" title="Numbered List" class="d-flex align-items-center fw-semibold fs-7">
              <span>1</span><span class="ms-1">.</span>
            </button>
            <div class="toolbar-separator"></div>
            <button type="button" id="link-btn" aria-label="Insert link" title="Insert Link"><i class="fas fa-link"></i></button>
          </div>
          <div id="message" class="email-body rich-text-editor" contenteditable="true" data-placeholder="Enter your announcement message..." style="min-height: 120px; padding: 12px; border: 1px solid #ddd; border-radius: 4px; outline: none;"></div>
        </div>
        <div class="footer-buttons">
          <button type="submit" class="btn-send">Send Announcement</button>
        </div>
      </form>
    </div>
    
    <!-- Sent History Tab Content -->
    <div class="email-container hidden" id="history-content">
      <div id="history-loading" class="text-center py-4" style="display: none;">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Loading announcement history...</p>
      </div>
      <table class="table mb-0" style="min-width: 600px;" id="history-table">
        <thead>
          <tr>
            <th scope="col" class="py-2 px-2" style="background-color: #0f3a40; color: white;">Date Sent</th>
            <th scope="col" class="py-2 px-2" style="background-color: #0f3a40; color: white;">Subject</th>
            <th scope="col" class="py-2 px-2" style="background-color: #0f3a40; color: white;">Action</th>
          </tr>
        </thead>
        <tbody id="history-tbody">
          <tr>
            <td colspan="3" class="text-center py-4">Click "Sent History" tab to load announcements</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Announcement Details Modal -->
<div id="announcementDetailsModal" class="global-modal" aria-labelledby="announcementDetailsModalTitle" aria-modal="true" role="dialog">
  <div class="modal-container">
    <!-- Modal Header -->
    <div class="modal-header d-flex justify-content-between align-items-center mb-3">
      <h4 class="modal-title fw-bold" style="font-size: 1rem; color: #0f3a40;" id="announcementDetailsModalTitle">Announcement Details</h4>
      <button class="btn-back" onclick="closeAnnouncementModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <!-- Announcement Information -->
    <div class="form-info mb-3" style="background: #F0F0F0; border-radius: 1rem; padding: 1rem;">
      <p style="font-size: 0.85rem; margin-bottom: 0.5rem;"><strong>Date Sent:</strong> <span id="announcementDate">May 15, 2023</span></p>
      <p style="font-size: 0.85rem; margin-bottom: 0;"><strong>Subject:</strong> <span id="announcementSubject">Summer Break Activities</span></p>
    </div>

    <!-- Message Content Section -->
    <div class="mb-4">
      <label class="form-label fw-semibold" style="font-size: 0.85rem; color: #0f3a40;">Message Content</label>
      <div class="announcement-content" style="background: #ffffff; border: 1px solid #dee2e6; border-radius: 0.5rem; padding: 1rem; min-height: 200px;">
        <div id="announcementMessage" class="announcement-message" style="font-size: 0.85rem; line-height: 1.5;">
          <!-- Announcement message will be inserted here -->
        </div>
      </div>
    </div>

    <!-- Recipients Section -->
    <div class="d-flex justify-content-end">
      <button type="button" class="btn btn-outline-primary btn-sm" onclick="openEmailRecipientsModal()" style="font-size: 0.75rem;">
        <i class="fas fa-users me-1"></i> View Email Recipients
      </button>
    </div>
  </div>
</div>

<!-- Email Recipients Modal (Small modal beside announcement details) -->
<div id="emailRecipientsModal" class="global-modal" aria-labelledby="emailRecipientsModalTitle" aria-modal="true" role="dialog" style="display: none;">
  <div class="modal-container-small" style="position: fixed; top: 50%; right: 5%; transform: translateY(-50%); width: 500px; max-height: 80vh; overflow-y: auto; background: white; border-radius: 0.5rem; box-shadow: 0 4px 20px rgba(0,0,0,0.15); z-index: 1060;">
    <!-- Modal Header -->
    <div class="modal-header d-flex justify-content-between align-items-center mb-3" style="padding: 1rem; border-bottom: 1px solid #dee2e6;">
      <h5 class="modal-title fw-bold" style="font-size: 0.9rem; color: #0f3a40; margin: 0;" id="emailRecipientsModalTitle">Email Recipients</h5>
      <button class="btn-back" onclick="closeEmailRecipientsModal()" style="background: none; border: none; font-size: 1rem; cursor: pointer; color: #6c757d;">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <!-- Recipients Count -->
    <div style="padding: 0 1rem;">
      <div class="form-info mb-3" style="background: #F0F0F0; border-radius: 0.5rem; padding: 0.75rem;">
        <p style="font-size: 0.75rem; margin-bottom: 0.25rem;"><strong>Total Recipients:</strong> <span id="emailRecipientsCount">0</span></p>
        <p style="font-size: 0.7rem; margin-bottom: 0; color: #6c757d;">Users who received this announcement via email</p>
      </div>

      <!-- Recipients List -->
      <div class="mb-3">
        <div class="table-responsive">
          <table class="table table-sm" style="font-size: 0.7rem; margin-bottom: 0;">
            <thead style="background-color: #f8f9fa;">
              <tr>
                <th scope="col" class="fw-semibold" style="color: #495057; padding: 0.5rem 0.25rem;">Name</th>
                <th scope="col" class="fw-semibold" style="color: #495057; padding: 0.5rem 0.25rem;">Email</th>
                <th scope="col" class="fw-semibold" style="color: #495057; padding: 0.5rem 0.25rem;">Organization</th>
              </tr>
            </thead>
            <tbody id="emailRecipientsList" style="max-height: 300px; overflow-y: auto; text-align: left;">
              <tr>
                <td colspan="3" class="text-center" style="padding: 1rem; color: #6c757d;">Loading recipients...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Recipients List Modal -->
<div id="recipientsModal" class="global-modal" aria-labelledby="recipientsModalTitle" aria-modal="true" role="dialog">
  <div class="modal-container">
    <!-- Modal Header -->
    <div class="modal-header d-flex justify-content-between align-items-center mb-3">
      <h4 class="modal-title fw-bold" style="font-size: 1rem; color: #0f3a40;" id="recipientsModalTitle">Selected Recipients</h4>
      <button class="btn-back" onclick="closeRecipientsModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <!-- Recipients Information Section -->
    <div class="form-info mb-4" style="background: #F0F0F0; border-radius: 1rem; padding: 1rem;">
      <p style="font-size: 0.75rem; margin-bottom: 0.5rem;"><strong>Total Organizations Selected:</strong> <span id="totalSelected">0</span></p>
      <p style="font-size: 0.75rem; margin-bottom: 0;"><strong>Announcement will be sent to all of the selected organizations</strong></p>
    </div>

    <!-- Selected Organizations Section -->
    <div class="form-info">
      <h6 class="fw-semibold mb-3" style="font-size: 0.75rem;">Selected Organizations</h6>
      <div class="table-responsive">
        <table class="table table-sm" style="font-size: 0.75rem;">
          <thead style="background-color: #0f3a40;">
            <tr>
              <th scope="col" class="fw-semibold" style="color: white;">Organization Name</th>
            </tr>
          </thead>
          <tbody id="recipientsList">
            <tr>
              <td class="text-center">No organizations selected</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const tabCreate = document.getElementById('tab-create');
    const tabHistory = document.getElementById('tab-history');
    const createContent = document.getElementById('create-content');
    const historyContent = document.getElementById('history-content');
    const organizationSelect = document.getElementById('organizations');
    const viewRecipientsBtn = document.getElementById('view-recipients-btn');
    
    tabCreate.addEventListener('click', function() {
      tabCreate.classList.add('active');
      tabHistory.classList.remove('active');
      createContent.classList.remove('hidden');
      historyContent.classList.add('hidden');
    });
    
    tabHistory.addEventListener('click', function() {
      tabHistory.classList.add('active');
      tabCreate.classList.remove('active');
      historyContent.classList.remove('hidden');
      createContent.classList.add('hidden');
      
      // Load announcement history
      loadAnnouncementHistory();
    });
    
    // Pre-select "All Organizations" by default
    const allOrganizationsOption = organizationSelect.querySelector('option[value="all"]');
    if (allOrganizationsOption) {
      allOrganizationsOption.selected = true;
    }
    
    // Rich text editor functionality
    const messageEditor = document.getElementById('message');
    
    // Add placeholder functionality
    function updatePlaceholder() {
      if (messageEditor.textContent.trim() === '') {
        messageEditor.classList.add('empty');
      } else {
        messageEditor.classList.remove('empty');
      }
    }
    
    messageEditor.addEventListener('input', updatePlaceholder);
    messageEditor.addEventListener('focus', updatePlaceholder);
    messageEditor.addEventListener('blur', updatePlaceholder);
    
    // Initialize placeholder
    updatePlaceholder();
    
    // Styling button functionality
    document.getElementById('bold-btn').addEventListener('click', function() {
      document.execCommand('bold', false, null);
      messageEditor.focus();
    });
    
    document.getElementById('italic-btn').addEventListener('click', function() {
      document.execCommand('italic', false, null);
      messageEditor.focus();
    });
    
    document.getElementById('underline-btn').addEventListener('click', function() {
      document.execCommand('underline', false, null);
      messageEditor.focus();
    });
    
    document.getElementById('bullet-list-btn').addEventListener('click', function() {
      document.execCommand('insertUnorderedList', false, null);
      messageEditor.focus();
    });
    
    document.getElementById('numbered-list-btn').addEventListener('click', function() {
      document.execCommand('insertOrderedList', false, null);
      messageEditor.focus();
    });
    
    document.getElementById('link-btn').addEventListener('click', function() {
      const url = prompt('Enter the URL:');
      if (url) {
        document.execCommand('createLink', false, url);
        messageEditor.focus();
      }
    });
    
    // Alignment button functionality
    const alignmentButtons = {
      'align-left-btn': 'justifyLeft',
      'align-center-btn': 'justifyCenter',
      'align-right-btn': 'justifyRight',
      'align-justify-btn': 'justifyFull'
    };
    
    function updateAlignmentButtons(activeButton) {
      // Remove active class from all alignment buttons
      Object.keys(alignmentButtons).forEach(buttonId => {
        document.getElementById(buttonId).classList.remove('active');
      });
      // Add active class to the clicked button
      if (activeButton) {
        activeButton.classList.add('active');
      }
    }
    
    Object.keys(alignmentButtons).forEach(buttonId => {
      document.getElementById(buttonId).addEventListener('click', function() {
        document.execCommand(alignmentButtons[buttonId], false, null);
        updateAlignmentButtons(this);
        messageEditor.focus();
      });
    });
    
    // Set default left alignment
    messageEditor.style.textAlign = 'left';
    
    // Handle organization selection changes
    organizationSelect.addEventListener('change', function() {
      updateViewRecipientsButton();
    });
    
    function updateViewRecipientsButton() {
      const selectedOptions = Array.from(organizationSelect.selectedOptions);
      
      // Show button if more than one organization is selected
      if (selectedOptions.length > 1) {
        viewRecipientsBtn.classList.remove('hidden');
      } else {
        viewRecipientsBtn.classList.add('hidden');
      }
    }
    
    // Form submission
    document.getElementById('announcement-form').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const subject = document.getElementById('subject').value.trim();
      const message = document.getElementById('message').innerHTML.trim();
      const selectedOptions = Array.from(organizationSelect.selectedOptions);
      
      if (!subject) {
        alert('Please enter a subject for the announcement.');
        return;
      }
      
      if (!message || message === '<br>' || message === '<div><br></div>') {
        alert('Please enter a message for the announcement.');
        return;
      }
      
      if (selectedOptions.length === 0) {
        alert('Please select at least one organization.');
        return;
      }
      
      // Create confirmation message
      let recipientText;
      if (selectedOptions.length === 1) {
        recipientText = selectedOptions[0].textContent;
      } else {
        recipientText = `${selectedOptions.length} organizations`;
      }
      
      if (confirm(`Send announcement "${subject}" to: ${recipientText}?`)) {
        // Prepare form data
        const formData = new FormData();
        formData.append('subject', subject);
        formData.append('message', message);
        
        // Add selected organization IDs
        selectedOptions.forEach(option => {
          formData.append('organization_ids', option.value);
        });
        
        // Show loading state
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        submitBtn.textContent = 'Sending...';
        submitBtn.disabled = true;
        
        // Get CSRF token from meta tag
        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;
        
        // Prepare headers
        const headers = {
          'X-Requested-With': 'XMLHttpRequest'
        };
        
        // Add CSRF token if available
        if (csrfToken) {
          headers['X-CSRFToken'] = csrfToken;
        }
        
        // Send the announcement
        fetch(this.action, {
          method: 'POST',
          body: formData,
          headers: headers,
          credentials: 'same-origin' // Include cookies for CSRF token
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('Announcement sent successfully!');
            
            // Reset form
            this.reset();
            
            // Clear the rich text editor
            messageEditor.innerHTML = '';
            messageEditor.style.textAlign = 'left';
            updatePlaceholder();
            
            // Reset alignment buttons to default (left align)
            updateAlignmentButtons(document.getElementById('align-left-btn'));
            
            // Restore default "All Organizations" selection
            const allOrganizationsOption = organizationSelect.querySelector('option[value="all"]');
            if (allOrganizationsOption) {
              allOrganizationsOption.selected = true;
            }
            
            // Update button visibility
            updateViewRecipientsButton();
            
            // Refresh the sent history tab if it's active
            if (tabHistory.classList.contains('active')) {
              location.reload();
            }
          } else {
            alert('Error sending announcement: ' + (data.message || 'Unknown error'));
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Error sending announcement. Please try again.');
        })
        .finally(() => {
          // Restore button state
          submitBtn.textContent = originalText;
          submitBtn.disabled = false;
        });
      }
    });
    
    // Initialize button state
    updateViewRecipientsButton();
  });
  
  // Function to load announcement history
  function loadAnnouncementHistory() {
    const historyTbody = document.getElementById('history-tbody');
    const historyLoading = document.getElementById('history-loading');
    const historyTable = document.getElementById('history-table');
    
    // Show loading state
    historyLoading.style.display = 'block';
    historyTable.style.display = 'none';
    
    fetch('{{ url_for("announcement.get_announcements") }}')
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          historyTbody.innerHTML = '';
          
          if (data.announcements.length === 0) {
            historyTbody.innerHTML = '<tr><td colspan="3" class="text-center py-4">No announcements sent yet</td></tr>';
          } else {
            data.announcements.forEach(announcement => {
              const row = document.createElement('tr');
              row.innerHTML = `
                <td class="py-2 px-2">${announcement.date_sent}</td>
                <td class="py-2 px-2">${announcement.subject}</td>
                <td class="py-2 px-2">
                  <button type="button" class="btn btn-primary" onclick="openAnnouncementModal('${announcement.date_sent}', '${announcement.subject.replace(/'/g, "\\'")}', ${announcement.announcement_id})">View Details</button>
                </td>
              `;
              historyTbody.appendChild(row);
            });
          }
        } else {
          historyTbody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-danger">Error loading announcements</td></tr>';
        }
      })
      .catch(error => {
        console.error('Error loading announcements:', error);
        historyTbody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-danger">Error loading announcements</td></tr>';
      })
      .finally(() => {
        // Hide loading state
        historyLoading.style.display = 'none';
        historyTable.style.display = 'table';
      });
  }
  
  // Function to open the announcement modal with specific announcement data
  function openAnnouncementModal(date, subject, announcementIdOrMessage) {
    const modal = document.getElementById('announcementDetailsModal');
    
    // Check if the third parameter is an ID (number) or message (string)
    if (typeof announcementIdOrMessage === 'number') {
      // Store the announcement ID in the modal's dataset
      modal.dataset.announcementId = announcementIdOrMessage;
      
      // Load announcement details from backend
      fetch(`{{ url_for("announcement.get_announcement_details", announcement_id=0) }}`.replace('0', announcementIdOrMessage))
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            document.getElementById('announcementDate').textContent = date;
            document.getElementById('announcementSubject').textContent = subject;
            document.getElementById('announcementMessage').innerHTML = data.announcement.message;
            
            // Show the modal
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
          } else {
            alert('Error loading announcement details');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Error loading announcement details');
        });
    } else {
      // Legacy support for static data (message passed directly)
      // Clear announcement ID for legacy mode
      delete modal.dataset.announcementId;
      
      document.getElementById('announcementDate').textContent = date;
      document.getElementById('announcementSubject').textContent = subject;
      document.getElementById('announcementMessage').textContent = announcementIdOrMessage;
      
      // Show the modal
      modal.classList.add('show');
      document.body.style.overflow = 'hidden';
    }
  }

  // Function to close the announcement modal
  function closeAnnouncementModal() {
    document.getElementById('announcementDetailsModal').classList.remove('show');
    document.body.style.overflow = ''; // Restore scrolling
  }

  // Function to open the recipients modal
  function openRecipientsModal() {
    const organizationSelect = document.getElementById('organizations');
    const selectedOptions = Array.from(organizationSelect.selectedOptions);
    const recipientsList = document.getElementById('recipientsList');
    const totalSelected = document.getElementById('totalSelected');
    
    // Update total count
    totalSelected.textContent = selectedOptions.length;
    
    // Clear existing table rows
    recipientsList.innerHTML = '';
    
    // Add selected organizations to the table
    if (selectedOptions.length > 0) {
      selectedOptions.forEach(option => {
        const row = document.createElement('tr');
        row.innerHTML = `<td>${option.textContent}</td>`;
        recipientsList.appendChild(row);
      });
    } else {
      recipientsList.innerHTML = '<tr><td class="text-center text-muted">No organizations selected</td></tr>';
    }
    
    // Show the modal
    document.getElementById('recipientsModal').classList.add('show');
    document.body.style.overflow = 'hidden';
  }

  // Function to close the recipients modal
  function closeRecipientsModal() {
    document.getElementById('recipientsModal').classList.remove('show');
    document.body.style.overflow = '';
  }

  // Close modal when clicking outside the modal content
  document.getElementById('announcementDetailsModal').addEventListener('click', function(event) {
    if (event.target === this) {
      closeAnnouncementModal();
    }
  });

  // Close recipients modal when clicking outside the modal content
  document.getElementById('recipientsModal').addEventListener('click', function(event) {
    if (event.target === this) {
      closeRecipientsModal();
    }
  });

  // Function to open the email recipients modal
  function openEmailRecipientsModal() {
    // Get the current announcement ID from the modal (we'll need to store this when opening the announcement modal)
    const announcementId = document.getElementById('announcementDetailsModal').dataset.announcementId;
    
    if (!announcementId) {
      alert('Unable to load recipients. Please try again.');
      return;
    }
    
    // Show the modal first
    document.getElementById('emailRecipientsModal').style.display = 'block';
    
    // Load recipients data
    fetch(`{{ url_for("announcement.get_announcement_recipients", announcement_id=0) }}`.replace('0', announcementId))
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const recipientsList = document.getElementById('emailRecipientsList');
          const recipientsCount = document.getElementById('emailRecipientsCount');
          
          // Update count
          recipientsCount.textContent = data.recipients.length;
          
          // Clear existing rows
          recipientsList.innerHTML = '';
          
          if (data.recipients.length === 0) {
            recipientsList.innerHTML = '<tr><td colspan="3" class="text-center" style="padding: 1rem; color: #6c757d;">No recipients found</td></tr>';
          } else {
            // Add recipient rows
            data.recipients.forEach(recipient => {
              const row = document.createElement('tr');
              row.innerHTML = `
                <td style="padding: 0.5rem 0.25rem; border-bottom: 1px solid #dee2e6; text-align: left;">${recipient.name}</td>
                <td style="padding: 0.5rem 0.25rem; border-bottom: 1px solid #dee2e6; text-align: left;">${recipient.email}</td>
                <td style="padding: 0.5rem 0.25rem; border-bottom: 1px solid #dee2e6; text-align: left;">${recipient.organization}</td>
              `;
              recipientsList.appendChild(row);
            });
          }
        } else {
          document.getElementById('emailRecipientsList').innerHTML = '<tr><td colspan="3" class="text-center text-danger" style="padding: 1rem;">Error loading recipients</td></tr>';
        }
      })
      .catch(error => {
        console.error('Error loading recipients:', error);
        document.getElementById('emailRecipientsList').innerHTML = '<tr><td colspan="3" class="text-center text-danger" style="padding: 1rem;">Error loading recipients</td></tr>';
      });
  }

  // Function to close the email recipients modal
  function closeEmailRecipientsModal() {
    document.getElementById('emailRecipientsModal').style.display = 'none';
  }

  // Close email recipients modal when clicking outside
  document.getElementById('emailRecipientsModal').addEventListener('click', function(event) {
    if (event.target === this) {
      closeEmailRecipientsModal();
    }
  });

  // Close modal when pressing Escape key
  document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
      closeAnnouncementModal();
      closeEmailRecipientsModal();
    }
  });
</script>
{% endblock %}
{% extends "user/userbase.html" %}

{% block title %}Application{% endblock %}

{% block head_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/application.css') }}">
{% endblock %}

{% block content %}
<div class="container">
  <h2 class="org-header">New Organization Application</h2>
  <hr class="divider">
  
  <!-- Changed class from "row" to "row info-progress-row" -->
  <div class="row info-progress-row g-3">
    <div class="col-md-4">
      <section class="card mb-3 org-card">
        <div class="card-body p-3 p-md-4">
          <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-center gap-3">
            <div class="mb-3 mb-md-0">
              {% if organization and organization.logo_id %}
              <img alt="Organization Logo" class="rounded-circle" height="80" width="80" src="{{ url_for('user_organization.get_logo', logo_id=organization.logo_id) }}"/>
              {% else %}
              <img alt="Placeholder profile image" class="rounded-circle" height="80" width="80" src="{{ url_for('static', filename='images/placeholder-logo.png') }}"/>
              {% endif %}
            </div>
            <div>
              <p class="fw-semibold mb-1">ORGANIZATION</p>
              <p class="mb-2 lh-sm small">{{ organization.organization_name if organization else 'No Organization' }}</p>
              <p class="mb-0 small">
                <span class="fw-semibold">Type:</span>
                {{ organization.type if organization else 'N/A' }}
              </p>
              <button type="button" class="btn btn-sm btn-outline-light mt-2" onclick="openUpdateOrgModal()">Update Information</button>
            </div>
          </div>
        </div>
      </section>
    </div>
    <div class="col-md-8">
      <!-- Application Progress -->
      <section class="card mb-3 {% if application %}{% if application.status.lower() == 'pending' %}status-pending{% elif application.status.lower() == 'approved' %}status-approved{% elif application.status.lower() == 'rejected' %}status-rejected{% elif application.status.lower() == 'verified' %}status-verified{% else %}status-incomplete{% endif %}{% else %}status-incomplete{% endif %}">
        <div class="card-body p-3 p-md-4">
          <div class="d-flex justify-content-between align-items-start mb-3">
            <div>
              <p class="fw-semibold fs-6 mb-0">APPLICATION PROGRESS</p>
              {% if application %}
              <p class="small text-secondary mb-1">Application Type: {{ application.type }}</p>
              <p class="fw-semibold small mb-0">Status: {{ application.status }}</p>
              {% else %}
              <p class="small text-secondary mb-1">No application data available</p>
              {% endif %}
            </div>
            <div>
              {% if application %}
                {% if application.status.lower() == 'pending' %}
                <span class="badge bg-primary">Pending</span>
                {% elif application.status.lower() == 'approved' %}
                <span class="badge bg-success">Approved</span>
                {% elif application.status.lower() == 'rejected' %}
                <span class="badge bg-danger">Rejected</span>
                {% elif application.status.lower() == 'verified' %}
                <span class="badge bg-success">Verified</span>
                {% else %}
                <span class="badge bg-secondary">{{ application.status }}</span>
                {% endif %}
              {% else %}
                <span class="badge bg-secondary">No Data</span>
              {% endif %}
            </div>
          </div>
          
          <div class="progress mb-3 progress-thin">
            {% if application %}
              {% if application.status.lower() == 'pending' %}
              <div class="progress-bar bg-primary" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
              {% elif application.status.lower() == 'approved' %}
              <div class="progress-bar bg-success" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
              {% elif application.status.lower() == 'rejected' %}
              <div class="progress-bar bg-danger" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
              {% elif application.status.lower() == 'verified' %}
              <div class="progress-bar bg-success" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
              {% else %}
              <div class="progress-bar bg-dark" role="progressbar" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100"></div>
              {% endif %}
            {% else %}
              <div class="progress-bar bg-dark" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
            {% endif %}
          </div>
          
          <div class="d-flex justify-content-between small text-secondary">
            <div class="d-flex align-items-center gap-1">
              <i class="fas fa-check-circle text-success"></i>
              <span>Verified: </span>
            </div>
            <div class="d-flex align-items-center gap-1">
              <i class="fas fa-clock text-primary"></i>
              <span>Pending: </span>
            </div>
            <div class="d-flex align-items-center gap-1">
              <i class="fas fa-exclamation-circle text-warning"></i>
              <span>Needs Revision: </span>
            </div>
            <div class="d-flex align-items-center gap-1">
              <i class="fas fa-times-circle text-danger"></i>
              <span>Rejected: </span>
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>
  
  <!-- Document Upload Title -->
  <div class="card mb-3 py-3 px-4">
    <div class="card-body p-0">
      <div class="d-flex justify-content-between align-items-center">
        <div class="fw-semibold">DOCUMENT UPLOAD</div>
        <div>
          <button type="button" class="btn btn-sm btn-outline-danger me-2" onclick="deleteAllFiles()">
            <i class="fas fa-trash"></i> Delete All Files
          </button>
          <button type="button" class="btn btn-sm btn-outline-primary" onclick="loadApplicationFiles()">
            <i class="fas fa-sync-alt"></i> Refresh
          </button>
        </div>
      </div>
    </div>
  </div>
  
  {% macro document_card(title) %}
  <div class="col-12 col-md-4">
    <div class="card h-100 document-card border-0 shadow-sm">
      <div class="card-body p-3 p-md-4">
        <div class="d-flex align-items-center mb-3">
          <span class="small fw-semibold">{{ title }}</span>
          <span class="badge bg-secondary status-badge">
            <i class="fas fa-question-circle"></i> No File
          </span>
        </div>
        
        <div class="dropzone mb-3">
          <input type="file" class="file-input" accept=".pdf,.doc,.docx" style="display: none;"/>
          <i class="fas fa-arrow-up mb-1"></i>
          Drag & drop or click to upload
        </div>
        
        <div class="d-flex justify-content-between align-items-center gap-2">
          <button class="btn btn-outline-dark btn-sm" type="button">Preview</button>
          <button class="btn btn-outline-secondary btn-sm" type="button">Select File</button>
          <button class="btn btn-primary btn-sm" type="button">Upload</button>
        </div>
      </div>
    </div>
  </div>
  {% endmacro %}
  
  <!-- Document Upload Forms -->
  <div class="row g-3 mb-3 justify-content-left">
    <!-- Form 1 -->
    {{ document_card('Form 1A -APPLICATION FOR RECOGNITION') }}
    
    <!-- Form 2 -->
    {{ document_card('Form 2 - LETTER OF ACCEPTANCE') }}
    
    <!-- Form 3 -->
    {{ document_card('Form 3 - LIST OF PROGRAMS/PROJECTS/ ACTIVITIES') }}
  </div>
  
  <div class="row g-3 mb-3 justify-content-left">
    <!-- Form 4 -->
    {{ document_card('Form 4 - LIST OF MEMBERS') }}
    
    <!-- Board of Officers -->
    {{ document_card('BOARD OF OFFICERS') }}
    
    <!-- Constitution and Bylaws -->
    {{ document_card('CONSTITUTION AND BYLAWS') }}
    
    <!-- Logo with Explanation -->
    {{ document_card('LOGO WITH EXPLANATION') }}
  </div>

  <!-- Feedback Section -->
  <section class="card mb-3">
    <div class="card-body p-3 p-md-4">
      <h3 class="fw-semibold fs-6 mb-3">FEEDBACK</h3>
      
      <div class="feedback-history-tabs">
        <div class="feedback-tab active" id="received-tab-btn">Received Feedback <span class="feedback-count" id="received-feedback-count">0</span></div>
      </div>
      
      <div class="feedback-tab-content active" id="received-tab">
        <!-- Feedback items will be dynamically loaded here -->
        <div class="text-center p-4">
          <p class="text-muted">No feedback available.</p>
        </div>
      </div>
    </div>
  </section>
</div>

<!-- Update Organization Modal -->
<div id="updateOrgModal" class="global-modal" aria-labelledby="updateOrgModalTitle" aria-modal="true" role="dialog">
  <div class="modal-container">

    <div class="modal-section">
      <h2 class="form-title">Update Organization Information</h2>
      
      <form id="updateOrgForm" method="post" action="/organization/update-organization" enctype="multipart/form-data" class="mt-4">
        <!-- Logo Upload -->
        <div class="mb-3">
          <label for="orgLogo" class="form-label">Organization Logo</label>
          <div class="d-flex align-items-center gap-3">
            <div class="current-logo">
              {% if organization and organization.logo_id %}
              <img id="currentLogo" alt="Current Organization Logo" class="rounded-circle" height="80" width="80" src="{{ url_for('user_organization.get_logo', logo_id=organization.logo_id) }}"/>
              {% else %}
              <img id="currentLogo" alt="Placeholder profile image" class="rounded-circle" height="80" width="80" src="{{ url_for('static', filename='images/placeholder-logo.png') }}"/>
              {% endif %}
            </div>
            <div class="flex-grow-1">
              <input type="file" class="form-control" id="orgLogo" name="logo" accept="image/*">
              <div class="form-text">Upload a new logo (optional)</div>
            </div>
          </div>
        </div>
        
        <!-- Organization Name -->
        <div class="mb-3">
          <label for="orgName" class="form-label">Organization Name</label>
          <input type="text" class="form-control" id="orgName" name="organization_name" value="{{ organization.organization_name if organization else '' }}" required>
        </div>
        
        <!-- Organization Type -->
        <div class="mb-3">
          <label for="orgType" class="form-label">Organization Type</label>
          <select class="form-select" id="orgType" name="type" required>
            <option value="" disabled>Select organization type</option>
            <option value="Academic" {% if organization and organization.type == 'Academic' %}selected{% endif %}>Academic</option>
            <option value="Cultural" {% if organization and organization.type == 'Cultural' %}selected{% endif %}>Cultural</option>
            <option value="Religious" {% if organization and organization.type == 'Religious' %}selected{% endif %}>Religious</option>
            <option value="Sports" {% if organization and organization.type == 'Sports' %}selected{% endif %}>Sports</option>
            <option value="Service" {% if organization and organization.type == 'Service' %}selected{% endif %}>Service</option>
            <option value="Professional" {% if organization and organization.type == 'Professional' %}selected{% endif %}>Professional</option>
            <option value="Other" {% if organization and organization.type == 'Other' %}selected{% endif %}>Other</option>
          </select>
        </div>
        
        <!-- Logo Description -->
        <div class="mb-3">
          <label for="logoDescription" class="form-label">Logo Description</label>
          <textarea class="form-control" id="logoDescription" name="logo_description" rows="4" required>{{ organization.logo.description if organization and organization.logo_id and organization.logo else '' }}</textarea>
        </div>
        
        <!-- Form Actions -->
        <div class="d-flex justify-content-end gap-2 mt-4">
          <button type="button" class="btn btn-secondary" onclick="closeUpdateOrgModal()">Cancel</button>
          <button type="submit" class="btn btn-primary">Update</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Reply Modal -->
<div id="replyModal" class="global-modal" aria-labelledby="replyModalTitle" aria-modal="true" role="dialog">
  <div class="modal-container">

    <div class="modal-section">
      <h2 class="form-title">Reply to Feedback</h2>
      

      <div class="feedback-content mb-4">
        <h3 class="fw-semibold fs-6 mb-2">Admin's Message</h3>
        <div class="feedback-message p-3 bg-light rounded">
          <p>The submitted list of members is missing contact information for the executive board members. Please revise and resubmit with complete information.</p>
        </div>
      </div>

      <div class="file-reference mb-4">
        <h3 class="fw-semibold fs-6 mb-2">Related File</h3>
        <div class="file-info p-3 bg-light rounded">
          <p><strong>File:</strong> listofmembers.pdf</p>
        </div>
      </div>

      <form id="reply-form">
        <div class="mb-3">
          <label for="reply-subject" class="form-label">Subject</label>
          <input type="text" class="form-control" id="reply-subject" name="subject" autocomplete="off" />
        </div>
        <div class="mb-4">
          <label for="reply-message" class="form-label">Message Content</label>
          <textarea class="form-control" id="reply-message" name="message" rows="8"></textarea>
        </div>
        <div class="d-flex justify-content-end">
          <button type="submit" class="btn-send">Send Reply</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Loading Modal -->
<div class="global-modal" id="loadingModal" aria-labelledby="loadingModalTitle" aria-modal="true" role="dialog">
  <div class="modal-content p-4 text-center" style="width: auto; max-width: 300px; margin: 0 auto; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
    <div class="d-flex justify-content-center">
      <div class="spinner-border text-primary mb-3" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>
    <p id="loadingMessage">Loading...</p>
  </div>
</div>

<!-- Preview Modal -->
<div class="global-modal" id="previewModal" aria-labelledby="previewModalTitle" aria-modal="true" role="dialog">
  <div id="previewModalContent" class="preview-modal-content">
    <!-- Content will be dynamically inserted here -->
  </div>
</div>

{% block extra_js %}
<!-- Common modules -->
<script src="{{ url_for('static', filename='js/common/dom-utils.js') }}?v={{ cache_version }}"></script>
<script src="{{ url_for('static', filename='js/common/file-status.js') }}?v={{ cache_version }}"></script>
<script src="{{ url_for('static', filename='js/common/file-preview.js') }}?v={{ cache_version }}"></script>
<!-- User-specific application script -->
<script src="{{ url_for('static', filename='js/user/application.js') }}?v={{ cache_version }}"></script>
{% endblock %}

{% endblock %}
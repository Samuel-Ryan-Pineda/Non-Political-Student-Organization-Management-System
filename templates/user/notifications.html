{% extends 'user/userbase.html' %}

{% block title %}Notifications{% endblock %}

{% block head_css %}
<link
  href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap"
  rel="stylesheet"
/>
<style>
  /* Notifications page styling */
  .notification-subject {
    font-weight: 600;
    font-size: 0.875rem; /* 14px */
    color: #212529;
    text-align: left;
  }
  .notification-message {
    font-weight: 400;
    font-size: 0.8125rem; /* 13px */
    color: #495057;
    margin-top: 0.125rem;
    text-align: left;
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    line-height: 1.4;
  }
  .notification-time {
    font-size: 0.75rem; /* 12px */
    color: #6c757d;
    white-space: nowrap;
  }
  
  .notification-card {
    background-color: #fff;
    border-radius: 0.375rem;
    box-shadow: 0 0.125rem 0.25rem rgb(0 0 0 / 0.075);
    padding: 1rem 1.25rem;
    margin-bottom: 1rem;
    display: flex;
    flex-direction: column;
    border-left: 3px solid transparent;
    transition: all 0.2s ease;
  }
  
  .notification-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    min-width: 40px;
    margin-right: 15px;
    color: #6c757d;
  }
  
  .notification-icon i {
    font-size: 1.25rem;
  }
  .notification-card.unread {
    background-color: #f8f9fa;
    border-left: 3px solid #0d6efd;
  }
  .notification-card:hover {
    box-shadow: 0 0.25rem 0.5rem rgb(0 0 0 / 0.1);
    cursor: pointer;
  }
  
  /* Modal styling */
  .notification-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 1050;
    overflow-y: auto;
  }
  
  .notification-modal-content {
    background-color: #fff;
    margin: 40px auto;
    padding: 20px;
    border-radius: 8px;
    width: 90%;
    max-width: 600px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    position: relative;
    text-align: left;
  }
  
  .notification-modal-close {
    position: absolute;
    top: 15px;
    right: 20px;
    font-size: 1.25rem;
    cursor: pointer;
    color: #6c757d;
  }
  
  .notification-modal-header {
    margin-bottom: 15px;
    padding-bottom: 15px;
    border-bottom: 1px solid #dee2e6;
  }
  
  .notification-modal-header h4 {
    font-size: 0.875rem;
    font-weight: 600;
    margin-top: 0.5rem;
    margin-bottom: 0.25rem;
    color: #212529;
  }
  
  .notification-modal-header small {
    font-size: 0.75rem;
    color: #6c757d;
    display: block;
  }
  
  .notification-modal-body {
    margin-bottom: 20px;
    font-size: 0.8125rem;
    line-height: 1.5;
    color: #495057;
  }
  
  .notification-modal-body p {
    margin-bottom: 1rem;
  }
  
  .notification-modal-body ol, 
  .notification-modal-body ul {
    padding-left: 1.5rem;
    margin-bottom: 1rem;
  }
  
  #modalFileInfo {
    font-size: 0.75rem;
    color: #6c757d;
  }
  @media (min-width: 576px) {
    .notification-card {
      flex-direction: row;
      justify-content: space-between;
      align-items: flex-start;
    }
    .notification-message {
      margin-top: 0;
    }
    .notification-content {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
  }
  
  /* Badge styling */
  .badge {
    font-size: 0.7rem;
    font-weight: 500;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
  }
  .badge.bg-primary {
    background-color: #0d6efd !important;
  }
  .badge.bg-info {
    background-color: #0dcaf0 !important;
    color: #000;
  }
  
  /* Empty state styling */
  .empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 300px;
    color: #6b7280;
  }
  
  .empty-state i {
    font-size: 3rem;
    margin-bottom: 1rem;
    color: #d1d5db;
  }
  
  .empty-state-text {
    font-size: 1rem;
  }

  
</style>
{% endblock %}

{% block content %}
<main class="container mb-5">
  {% if notifications %}
    {% for notification in notifications %}
    <div class="notification-card {% if not notification.is_read %}unread{% endif %}">
      <div class="notification-icon">
        {% if notification.type == 'announcement' %}
        <i class="fas fa-bullhorn"></i>
        {% elif notification.type == 'feedback' %}
        <i class="fas fa-file-alt"></i>
        {% endif %}
      </div>
      <div class="notification-content">
        {% if notification.type == 'announcement' %}
        <div class="d-flex align-items-center mb-1">
          <span class="badge bg-primary me-2">Announcement</span>
          <div class="notification-subject">{{ notification.subject }}</div>
        </div>
        <div class="notification-message" data-message="{{ notification.message }}">
          {{ notification.message|safe }}
          {% if notification.message|length > 150 %}
          <span class="text-primary">...</span>
          {% endif %}
        </div>
        {% elif notification.type == 'feedback' %}
        <div class="d-flex justify-content-start">
          <span class="badge bg-info me-2">Feedback</span>
        </div>
        <div class="notification-subject">{{ notification.subject }}</div>
        <div class="notification-message" data-message="{{ notification.message }}">
          {{ notification.message|safe }}
          {% if notification.message|length > 150 %}
          <span class="text-primary">...</span>
          {% endif %}
          {% if notification.file_name %}
          <div class="mt-1 small text-muted">File: {{ notification.file_name }}</div>
          {% endif %}
        </div>
        {% endif %}
      </div>
      <time class="notification-time mt-2 mt-sm-0">{{ notification.time }}</time>
    </div>
    {% endfor %}
  {% else %}
    <div class="empty-state">
      <i class="fas fa-bell-slash"></i>
      <p class="empty-state-text">You don't have any notifications yet.</p>
    </div>
  {% endif %}
</main>

<!-- Notification Modal -->
<div id="notificationModal" class="notification-modal">
  <div class="notification-modal-content">
    <span class="notification-modal-close">&times;</span>
    <div class="notification-modal-header">
      <div class="d-flex align-items-center">
        <div class="notification-icon me-2" id="modalIcon">
          <i class="fas"></i>
        </div>
        <span class="badge me-2" id="modalBadge"></span>
      </div>
      <h4 id="modalSubject" class="mb-0 mt-2"></h4>
      <small class="text-muted" id="modalTime"></small>
    </div>
    <div class="notification-modal-body" id="modalMessage"></div>
    <div id="modalFileInfo" class="mb-3" style="display: none;"></div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Get modal elements
    const modal = document.getElementById('notificationModal');
    const modalClose = document.querySelector('.notification-modal-close');
    const modalSubject = document.getElementById('modalSubject');
    const modalMessage = document.getElementById('modalMessage');
    const modalBadge = document.getElementById('modalBadge');
    const modalTime = document.getElementById('modalTime');
    const modalFileInfo = document.getElementById('modalFileInfo');
    const modalIcon = document.getElementById('modalIcon').querySelector('i');
    
    // Get all notification cards
    const notificationCards = document.querySelectorAll('.notification-card');
    
    // Add click event to each notification card
    notificationCards.forEach(card => {
      card.addEventListener('click', function() {
        // Get notification data
        const subject = card.querySelector('.notification-subject').textContent;
        const messageElement = card.querySelector('.notification-message');
        // Get the HTML content from the element instead of the data-message attribute
        const message = messageElement.innerHTML.trim();
        const time = card.querySelector('.notification-time').textContent;
        const badgeElement = card.querySelector('.badge');
        const badgeText = badgeElement ? badgeElement.textContent : '';
        const badgeClass = badgeElement ? badgeElement.classList.contains('bg-primary') ? 'bg-primary' : 'bg-info' : '';
        
        // Get file info if exists
        const fileInfo = card.querySelector('.small.text-muted');
        
        // Set modal content
        modalSubject.textContent = subject;
        modalMessage.innerHTML = message; // Use innerHTML instead of textContent to preserve HTML formatting
        modalTime.textContent = time;
        
        // Set badge
        modalBadge.textContent = badgeText;
        modalBadge.className = 'badge ' + badgeClass;
        
        // Set icon based on notification type
        if (badgeText === 'Announcement') {
          modalIcon.className = 'fas fa-bullhorn';
        } else if (badgeText === 'Feedback') {
          modalIcon.className = 'fas fa-file-alt';
        }
        
        // Set file info if exists
        if (fileInfo) {
          // Extract the file name from the file info text
          const fileInfoText = fileInfo.textContent;
          const fileNameMatch = fileInfoText.match(/File:\s*(.+)/i);
          
          if (fileNameMatch && fileNameMatch[1]) {
            const fileName = fileNameMatch[1].trim();
            
            // Check if the message already contains the file name
            // We need to escape special regex characters in the file name
            const escapedFileName = fileName.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            
            // Look for the file name in the message content
            if (message.includes(fileName)) {
              // File name already appears in the message, don't display it separately
              modalFileInfo.style.display = 'none';
            } else {
              modalFileInfo.textContent = fileInfoText;
              modalFileInfo.style.display = 'block';
            }
          } else {
            // No file name pattern found, display as is
            modalFileInfo.textContent = fileInfoText;
            modalFileInfo.style.display = 'block';
          }
        } else {
          modalFileInfo.style.display = 'none';
        }
        
        // Show modal
        modal.style.display = 'block';
        document.body.style.overflow = 'hidden'; // Prevent scrolling
      });
    });
    
    // Close modal when clicking the close button
    modalClose.addEventListener('click', function() {
      modal.style.display = 'none';
      document.body.style.overflow = ''; // Restore scrolling
    });
    
    // Close modal when clicking outside the modal content
    window.addEventListener('click', function(event) {
      if (event.target === modal) {
        modal.style.display = 'none';
        document.body.style.overflow = ''; // Restore scrolling
      }
    });
  });
</script>
{% endblock %}
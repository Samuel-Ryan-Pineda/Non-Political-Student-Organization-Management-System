{% extends 'user/userbase.html' %}

{% block title %}Document Compilation{% endblock %}

{% block head_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/orgfiles.css') }}?v={{ cache_version }}">
<style>
.form-label {
    background: white;
    border-radius: 0.375rem 0 0 0.375rem;
    padding: 0.375rem 1rem;
    font-weight: 500;
    font-size: 0.875rem;
    color: #0c3a47;
    white-space: nowrap;
    border: 1px solid transparent;
    border-right: none;
  }
  select.form-select {
    border-color: #0c3a47;
    border-radius: 0 0.375rem 0.375rem 0;
    color: #0c3a47;
    font-size: 0.875rem;
    padding-right: 2.5rem;
    position: relative;
    cursor: pointer;
    width: 100%; /* Ensure select takes full width of wrapper */
  }
  select.form-select:focus {
    box-shadow: 0 0 0 0.25rem rgba(12, 58, 71, 0.25);
    border-color: #0c3a47;
  }
  .select-wrapper {
    position: relative;
    flex: 1 1 auto;
    width: 100%; /* Ensure wrapper takes all available space */
  }
  .select-wrapper i {
    position: absolute;
    right: 1rem;
    top: 50%;
    transform: translateY(-50%);
    pointer-events: none;
    color: #0c3a47;
    font-size: 0.875rem;
  }
  .form-container {
    width: 100%;
    max-width: 100%;
  }
  form.year-select-form {
    width: 100%;
    display: flex;
    align-items: center;
  }
  .table thead {
    background-color: #0c3a47;
    color: white;
    font-weight: 600;
    font-size: 0.875rem;
  }
  .table td,
  .table th {
    vertical-align: middle;
    border-top: none;
    font-size: 0.75rem;
    color: #0c3a47;
  }
  .table tbody tr:not(:last-child) {
    border-bottom: 1px solid #e5e7eb;
  }
  .table tbody tr td:first-child {
    font-weight: 600;
  }
  .badge-verified {
    background-color: #cde6d6;
    color: #2f6e3e;
    font-weight: 600;
    border-radius: 9999px;
    padding: 0.25rem 0.75rem;
    font-size: 0.75rem;
    display: inline-block;
  }
  .btn-preview {
    border: 1px solid #0c3a47;
    color: #0c3a47;
    font-size: 0.75rem;
    padding: 0.25rem 1rem;
    border-radius: 0.375rem;
    background-color: transparent;
    transition: background-color 0.15s ease-in-out;
    text-decoration: none;
  }
  .btn-preview:hover,
  .btn-preview:focus {
    background-color: #f9fafb;
    color: #0c3a47;
    text-decoration: none;
  }
  .btn-feedback {
    background-color: #3b63f5;
    color: white;
    font-size: 0.75rem;
    padding: 0.25rem 1rem;
    border-radius: 0.375rem;
    border: none;
    transition: background-color 0.15s ease-in-out;
    text-decoration: none;
  }
  .btn-feedback:hover,
  .btn-feedback:focus {
    background-color: #2a4edb;
    color: white;
    text-decoration: none;
  }
  .badge {
    border-radius: 9999px;
    padding: 0.25rem 0.75rem;
    font-size: 0.75rem;
    font-weight: 600;
    display: inline-block;
  }
  .action-buttons {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 0.5rem;
  }
  @media (max-width: 575.98px) {
    body {
      padding: 1.5rem 1rem;
    }
    .form-label {
      border-radius: 0.375rem 0.375rem 0 0;
      border-right: 1px solid #0c3a47;
      border-bottom: none;
      padding: 0.375rem 0.75rem;
      white-space: normal;
    }
    .select-wrapper {
      flex: none;
      width: 100%;
      position: relative;
    }
    select.form-select {
      border-radius: 0 0 0.375rem 0.375rem;
      padding-right: 2rem;
    }
    .form-row {
      flex-direction: column;
      align-items: stretch;
    }
    .btn-preview,
    .btn-feedback {
      font-size: 0.75rem;
      padding: 0.25rem 0.75rem;
    }
    .table-responsive {
      overflow-x: auto;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <header class="mb-4">
        <h2 class="org-header text-start">Document Compilation</h2>
        <hr class="divider">
    </header>
    <form class="year-select-form mb-4" method="GET">
        <label for="academic-year" class="form-label mb-0">Academic Year:</label>
        <div class="select-wrapper">
          <select id="academic-year" name="academic_year" class="form-select" onchange="this.form.submit()">
            {% for year in available_years %}
              <option value="{{ year }}" {% if year == selected_academic_year %}selected{% endif %}>{{ year }}</option>
            {% endfor %}
          </select>
          <i class="fas fa-chevron-down"></i>
        </div>
    </form>
  
    <div class="bg-white rounded-3 p-4 table-responsive">
        {% if application_files %}
        <table class="table table-borderless align-middle mb-0" style="min-width: 700px;">
          <thead>
            <tr>
              <th scope="col" style="min-width: 200px; background-color: #0c3a47; color: white;">File Name</th>
              <th scope="col" style="min-width: 180px; background-color: #0c3a47; color: white;">Submission Date</th>
              <th scope="col" style="min-width: 120px; background-color: #0c3a47; color: white;">Status</th>
              <th scope="col" style="min-width: 140px; background-color: #0c3a47; color: white;">Action</th>
            </tr>
          </thead>
          <tbody class="text-start">
            {% for file in application_files %}
            <tr>
              <td>{{ file.file_name }}</td>
              <td>
                {% if file.submission_date %}
                  {{ file.submission_date.strftime('%B %d, %Y, %I:%M %p') }}
                {% else %}
                  Not available
                {% endif %}
              </td>
              <td class="text-center">
                {% set status_class = '' %}
                {% if file.status == 'Verified' %}
                  {% set status_class = 'status-verified' %}
                {% elif file.status == 'Pending' %}
                  {% set status_class = 'status-pending' %}
                {% elif file.status == 'Needs Revision' %}
                  {% set status_class = 'status-needs-revision' %}
                {% elif file.status == 'Rejected' %}
                  {% set status_class = 'status-rejected' %}
                {% endif %}
                <span class="status-badge {{ status_class }}">{{ file.status }}</span>
              </td>
              <td>
                <div class="action-buttons">
                  <button type="button" class="btn-preview" onclick="previewFile({{ file.app_file_id }}, '{{ file.file_name }}')">Preview</button>
                  <a href="{{ url_for('user_organization.get_application_file', file_id=file.app_file_id) }}?download=true" 
                     class="btn-feedback">Download</a>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% else %}
        <div class="text-center py-5">
          <p class="text-muted">No files found for the selected academic year.</p>
        </div>
        {% endif %}
      </div>
    </div>
</div>

<!-- Preview Modal -->
<div class="global-modal" id="previewModal" aria-labelledby="previewModalTitle" aria-modal="true" role="dialog">
  <div id="previewModalContent" class="preview-modal-content">
    <!-- Content will be dynamically inserted here -->
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/common/file-preview.js') }}"></script>
<script>
function previewFile(fileId, fileName) {
  console.log('previewFile called with:', { fileId, fileName });
  
  // Check if FilePreview module is available
  if (window.FilePreview) {
    console.log('Using FilePreview module');
    FilePreview.previewFile(fileId, fileName, function(fileId) {
      return `/organization/get-application-file/${fileId}`;
    });
  } else {
    console.log('FilePreview module not available, opening in new tab');
    // Fallback: open in new tab
    window.open(`/organization/get-application-file/${fileId}`, '_blank');
  }
}
</script>
{% endblock %}
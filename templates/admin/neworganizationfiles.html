{% extends 'admin/adminbase.html' %}

{% block title %}New Organization Application Files{% endblock %}

{% block head_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/orgfiles.css') }}">
{% endblock %}

{% block content %}
<main class="container">
  <h2 class="org-header">New Organizations</h2>
  <hr class="divider">
  <section class="bg-white rounded-3 p-4" aria-label="New Organization Application Details">
    <div class="d-flex justify-content-between align-items-start mb-3">
      <h2 class="highlight-title fs-6 fw-semibold mb-0">New Organization Application</h2>
      <a href="{{ url_for('admin_new_organization.neworganization') }}" type="button" class="btn btn-light btn-sm d-flex align-items-center gap-1 ">
        <i class="fas fa-arrow-left"></i> Back
      </a>
    </div>
    
    <div class="org-info">
      <p class="mb-1">
        <span class="fw-semibold">Organization:</span> {{ organization.organization_name }}
      </p>
      <p class="mb-4">
        <span class="fw-semibold">Submitted On:</span> {{ application.submission_date.strftime('%B %d, %Y, %I:%M %p') if application.submission_date else 'Not submitted' }}
      </p>
    </div>

    <div class="table-responsive">
      <table class="table align-middle">
        <thead>
          <tr>
            <th scope="col" style="text-align: left;">File Name</th>
            <th scope="col" style="text-align: left;">Date and Time</th>
            <th scope="col" style="text-align: center;">Status</th>
            <th scope="col" style="text-align: center;">Action</th>
          </tr>
        </thead>
        <tbody>
          {% if application_files %}
          {% for file in application_files %}
          <tr>
            <td class="fw-semibold" style="text-align: left;">{{ file.file_name }}</td>
            <td style="text-align: left;">{{ file.submission_date.strftime('%B %d, %Y, %I:%M %p') if file.submission_date else 'Not available' }}</td>
            <td>
              {% set status_class = '' %}
              {% if file.status == 'Verified' %}
                {% set status_class = 'status-verified' %}
              {% elif file.status == 'Pending' %}
                {% set status_class = 'status-pending' %}
              {% elif file.status == 'Needs Revision' %}
                {% set status_class = 'status-needs-revision' %}
              {% elif file.status == 'Rejected' %}
                {% set status_class = 'status-rejected' %}
              {% endif %}
              <span class="status-badge {{ status_class }}">{{ file.status }}</span>
            </td>
            <td>
              <div class="action-buttons d-flex justify-content-center gap-2">
                <button type="button" class="btn admin-preview-btn btn-sm" onclick="previewFile({{ file.app_file_id }}, '{{ file.file_name }}')"><i class="fas fa-eye"></i> Preview</button>
                
                <button type="button" class="btn btn-update btn-sm" onclick="openStatusModal({{ file.app_file_id }}, '{{ file.status }}', '{{ file.file_name }}', '{{ file.submission_date.strftime('%B %d, %Y, %I:%M %p') if file.submission_date else 'Not available' }}')">Update Status</button>
                <button type="button" class="btn btn-feedback btn-sm position-relative" 
                   onclick="openFeedbackModal('{{ file.file_name }}', '{% if file.form_code %}{{ file.form_code }} - {% endif %}{{ file.form_type }}', '{{ file.status }}')">
                  Add Feedback
                  {% if file.feedback_count and file.feedback_count > 0 %}
                  <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                    {{ file.feedback_count }}
                  </span>
                  {% endif %}
                </button>
              </div>
            </td>
          </tr>
          {% endfor %}
          {% else %}
          <tr>
            <td colspan="4" class="text-center py-4">
              <div class="alert alert-info mb-0">
                No files have been submitted for this application yet.
              </div>
            </td>
          </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </section>

  <!-- Feedback History Section -->
  <section class="feedback-history-section" aria-label="Feedback History">
    <div class="feedback-history-tabs">
      <div class="feedback-tab active" onclick="showTab('sent')">Sent Feedback <span class="feedback-count">2</span></div>
      <div class="feedback-tab" onclick="showTab('received')">Received Feedback <span class="feedback-count">1</span></div>
    </div>
    
    <!-- Sent Feedback Tab -->
    <div class="feedback-tab-content active" id="sent-tab">
      <!-- Feedback Item 1 -->
      <div class="feedback-card sent">
        <div class="feedback-card-header">
          <div class="feedback-card-title">Missing Information in Member List</div>
          <div class="feedback-card-date">July 10, 2025, 3:45 PM</div>
        </div>
        <div class="feedback-card-body">
          <p>The submitted list of members is missing contact information for the executive board members. Please revise and resubmit with complete information.</p>
        </div>
        <div class="feedback-card-file">
          <strong>File:</strong> listofmembers.pdf
        </div>
        <div class="d-flex justify-content-end mt-2">
          <button class="btn btn-view-feedback" onclick="openFeedbackDetail('sent', 1)">View Details</button>
        </div>
      </div>
      
      <!-- Feedback Item 2 -->
      <div class="feedback-card sent">
        <div class="feedback-card-header">
          <div class="feedback-card-title">Mentor Information Required</div>
          <div class="feedback-card-date">July 10, 2025, 4:00 PM</div>
        </div>
        <div class="feedback-card-body">
          <p>Please include faculty mentor information in the member list document as required by the guidelines. This should include their department, contact information, and years of experience.</p>
        </div>
        <div class="feedback-card-file">
          <strong>File:</strong> listofmembers.pdf
        </div>
        <div class="d-flex justify-content-end mt-2">
          <button class="btn btn-view-feedback" onclick="openFeedbackDetail('sent', 2)">View Details</button>
        </div>
      </div>
    </div>
    
    <!-- Received Feedback Tab -->
    <div class="feedback-tab-content" id="received-tab">
      <!-- Received Feedback Item 1 -->
      <div class="feedback-card received">
        <div class="feedback-card-header">
          <div class="feedback-card-title">Response to Member List Feedback</div>
          <div class="feedback-card-date">July 11, 2025, 9:30 AM</div>
        </div>
        <div class="feedback-card-body">
          <p>We have updated the member list with contact information for all executive board members as requested. The revised document has been uploaded for your review.</p>
        </div>
        <div class="feedback-card-file">
          <strong>File:</strong> listofmembers.pdf
        </div>
        <div class="d-flex justify-content-end mt-2">
          <button class="btn btn-view-feedback" onclick="openFeedbackDetail('received', 1)">View Details</button>
        </div>
      </div>
    </div>
  </section>

  <!-- Feedback Modal -->
  <div id="feedbackModal" class="global-modal" aria-labelledby="feedbackModalTitle" aria-modal="true" role="dialog">
    <div class="modal-container">
      <button type="button" class="btn-back" onclick="closeFeedbackModal()" aria-label="Close">
        <i class="fas fa-arrow-left"></i> Back
      </button>

      <div class="modal-section">
        <h2 class="form-title">Details</h2>
        <div class="form-info">
          <p><strong>Organization:</strong> Technological Advancement and Innovation Society of Future Engineers</p>
          <p><strong>File Name:</strong> <span id="file-name"></span></p>
          <p><strong>Form Type:</strong> <span id="form-type"></span></p>
          <p><strong>Form Status:</strong> <span id="form-status"></span></p>
        </div>

        <form id="feedback-form">
          <h2 class="form-title">Send a Feedback</h2>
          <div class="mb-3">
            <label for="subject" class="form-label">Subject</label>
            <input
              type="text"
              class="form-control"
              id="subject"
              name="subject"
              autocomplete="off"
            />
          </div>
          <div class="mb-4">
            <label for="message" class="form-label">Message Content</label>
            <textarea
              class="form-control"
              id="message"
              name="message"
              rows="8"
            ></textarea>
          </div>
          <div class="d-flex justify-content-end">
            <button type="submit" class="btn-send">Send Feedback</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Feedback Detail Modal -->
  <div id="feedbackDetailModal" class="global-modal feedback-detail-modal" aria-labelledby="feedbackDetailModalTitle" aria-modal="true" role="dialog">
    <div class="modal-container">
      <button type="button" class="btn-back" onclick="closeFeedbackDetailModal()" aria-label="Close">
        <i class="fas fa-arrow-left"></i> Back
      </button>

      <div class="modal-section">
        <div class="feedback-detail-header">
          <h2 class="form-title mb-0" id="feedback-detail-title">Feedback Detail</h2>
          <span class="feedback-badge" id="feedback-detail-badge">Sent</span>
        </div>
        
        <div class="feedback-metadata">
          <p><strong>Date:</strong> <span id="feedback-detail-date"></span></p>
          <p><strong>File:</strong> <span id="feedback-detail-file"></span></p>
          <p><strong>Form Type:</strong> <span id="feedback-detail-form-type"></span></p>
        </div>
        
        <div class="feedback-content">
          <h3 class="fs-6 fw-semibold mb-2" id="feedback-detail-subject"></h3>
          <p id="feedback-detail-message"></p>
        </div>
        
        <div class="feedback-reply-section" id="feedback-reply-section">
          <h3 class="fs-6 fw-semibold mb-3">Reply</h3>
          <div class="feedback-content">
            <h3 class="fs-6 fw-semibold mb-2" id="feedback-reply-subject"></h3>
            <p id="feedback-reply-message"></p>
            <div class="text-end text-muted mt-2" id="feedback-reply-date"></div>
          </div>
        </div>
        
        <div class="d-flex justify-content-end mt-3">
          <button type="button" class="btn btn-feedback" id="btn-reply-feedback">Reply to Feedback</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- File Preview Modal -->
  <div id="filePreviewModal" class="global-modal file-preview-modal" aria-labelledby="filePreviewModalTitle" aria-modal="true" role="dialog">
    <div class="modal-container modal-lg">
      <div class="modal-section">
        <div class="file-preview-header d-flex justify-content-between align-items-center mb-3">
          <h2 class="form-title mb-0" id="file-preview-title">File Preview</h2>
          <div class="d-flex align-items-center gap-2">
            <button type="button" class="btn btn-download" id="modal-download-btn" onclick="downloadCurrentFile()"><i class="fas fa-download"></i> Download</button>
            <button type="button" class="btn-close" onclick="closeFilePreviewModal()" aria-label="Close"></button>
          </div>
        </div>
        
        <div class="file-preview-content">
          <div id="file-preview-container" class="file-preview-container">
            <!-- File content will be loaded here -->
            <div class="text-center p-5" id="file-loading">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <p class="mt-3">Loading file preview...</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Status Update Modal -->
  <div id="statusUpdateModal" class="global-modal" aria-labelledby="statusUpdateModalTitle" aria-modal="true" role="dialog">
    <div class="modal-container">
      <button type="button" class="btn-back" onclick="closeStatusModal()" aria-label="Close">
        <i class="fas fa-arrow-left"></i> Back
      </button>

      <div class="modal-section">
        <h2 class="form-title">Update File Status</h2>
        <div class="form-info mb-3">
          <p><strong>File:</strong> <span id="status-file-name"></span></p>
          <p><strong>Submission Date:</strong> <span id="status-submission-date"></span></p>
        </div>
        <form id="status-update-form">
          <input type="hidden" id="file_id" name="file_id">
          <div class="mb-4">
            <label for="status" class="form-label">Select Status</label>
            <select class="form-control form-select" id="status" name="status" required>
              <option value="Verified">Verified</option>
              <option value="Needs Revision">Needs Revision</option>
              <option value="Rejected">Rejected</option>
            </select>
          </div>
          <div class="d-flex justify-content-end">
            <button type="submit" class="btn-send">Update Status</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</main>

{% block extra_js %}
<!-- Common modules -->
<script src="{{ url_for('static', filename='js/common/dom-utils.js') }}?v={{ cache_version }}"></script>
<script src="{{ url_for('static', filename='js/common/file-status.js') }}?v={{ cache_version }}"></script>
<script src="{{ url_for('static', filename='js/common/file-preview.js') }}?v={{ cache_version }}"></script>
<!-- Admin-specific application script -->
<script src="{{ url_for('static', filename='js/admin/neworganizationfiles.js') }}?v={{ cache_version }}"></script>
{% endblock %}

{% endblock content %}
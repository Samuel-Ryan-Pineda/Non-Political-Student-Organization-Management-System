{% extends 'admin/adminbase.html' %}

{% block title %}Organization Renewals{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/common/file-preview.js') }}"></script>
<script src="{{ url_for('static', filename='js/admin/organizationrenewals.js') }}" defer></script>
{% endblock %}

{% block head_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/orgfiles.css') }}?v={{ cache_version }}">
{% endblock %}

{% block content %}
<main class="container">
  <h2 class="org-header">Organization Renewals</h2>
  <hr class="divider">
  <section class="bg-white rounded-3 p-4" aria-label="Organization Renewal Application Details">
    <div class="d-flex justify-content-between align-items-start mb-3">
      <h2 class="highlight-title fs-6 fw-semibold mb-0">Organization Renewal Application</h2>
      <a href="/renewal" type="button" class="btn btn-light btn-sm d-flex align-items-center gap-1 ">
        <i class="fas fa-arrow-left"></i> Back
      </a>
    </div>
    
    <div class="org-info">
      <p class="mb-1">
        <span class="fw-semibold">Organization:</span> {{ organization.organization_name }}
      </p>
      <p class="mb-4">
        <span class="fw-semibold">Date Submitted:</span> {{ application.submission_date.strftime('%B %d, %Y') if application.submission_date else 'Not submitted' }}
      </p>
    </div>

    <div class="table-responsive">
      <table class="table align-middle">
        <thead>
          <tr>
            <th scope="col" style="text-align: left;">File Name</th>
            <th scope="col" style="text-align: left;">Submission Date</th>

            <th scope="col">Status</th>
            <th scope="col">Action</th>
          </tr>
        </thead>
          <tbody>
            {% if files %}          
            {% for file in files %}
            <tr>
              <td class="fw-semibold" style="text-align: left;">{{ file.filename }}</td>
              <td style="text-align: left;">{{ file.upload_date.strftime('%B %d, %Y, %I:%M %p') }}</td>
              <td>
                              {% set status_class = '' %}
              {% if file.status == 'Verified' %}
                {% set status_class = 'status-verified' %}
              {% elif file.status == 'Pending' %}
                {% set status_class = 'status-pending' %}
              {% elif file.status == 'Needs Revision' %}
                {% set status_class = 'status-needs-revision' %}
              {% elif file.status == 'Rejected' %}
                {% set status_class = 'status-rejected' %}
              {% endif %}
              <span class="status-badge {{ status_class }}">{{ file.status }}</span>
              </td>
              <td>
                <div class="action-buttons d-flex justify-content-center gap-2">
                  <!-- FIXED: Added onclick handler like in neworganizationfiles.html -->
                  <button type="button" 
                          class="btn admin-preview-btn btn-sm" 
                          data-app-file-id="{{ file.app_file_id }}" 
                          data-file-name="{{ file.filename }}"
                          onclick="previewFile({{ file.app_file_id }}, '{{ file.filename }}')">
                    <i class="fas fa-eye"></i> Preview
                  </button>
                  
                  <button type="button" 
                          class="btn btn-update btn-sm" 
                          data-app-file-id="{{ file.app_file_id }}"
                          data-current-status="{{ file.status }}"
                          data-file-name="{{ file.filename }}"
                          data-submission-date="{{ file.upload_date.strftime('%B %d, %Y, %I:%M %p') if file.upload_date else 'Not available' }}"
                          onclick="openStatusModal({{ file.app_file_id }}, '{{ file.status }}', '{{ file.filename }}', '{{ file.upload_date.strftime('%B %d, %Y, %I:%M %p') if file.upload_date else 'Not available' }}')">
                    Update Status
                  </button>
                </div>
              </td>
            </tr>
            {% endfor %}
            {% else %}
            <tr>
              <td colspan="4" class="text-center">No files found for this renewal application.</td>
            </tr>
            {% endif %}
          </tbody>
      </table>
    </div>
  </section>

  <!-- Feedback History Section -->
  <section class="feedback-history-section" aria-label="Feedback History">
    <h3 class="fw-semibold fs-6 mb-3" style="text-align: left;">FEEDBACK</h3>
    <div class="feedback-history-tabs">
      <div class="feedback-tab active">Sent Feedback <span class="feedback-count">{{ sent_feedbacks|length if sent_feedbacks else 0 }}</span></div>
    </div>
    
    <!-- Feedback Content -->
    <div class="feedback-tab-content active">
      {% if sent_feedbacks %}
        {% for feedback in sent_feedbacks %}
        <div class="feedback-card sent">
          <div class="feedback-card-header">
            <div class="feedback-card-title">{{ feedback.subject }}</div>
            <div class="feedback-card-date">{{ feedback.date_sent.strftime('%B %d, %Y, %I:%M %p') if feedback.date_sent else 'Not available' }}</div>
          </div>
          <div class="feedback-card-file mb-2">
            <strong>File:</strong> {{ feedback.application_file.file_name if feedback.application_file else 'Unknown' }}
          </div>
          <div class="feedback-card-body">
            <p>{{ feedback.message }}</p>
          </div>
          <div class="d-flex justify-content-end mt-2">
            <button class="btn btn-view-feedback" onclick="editFeedback({{ feedback.feedback_id }})">Edit Feedback</button>
          </div>
        </div>
        {% endfor %}
      {% else %}
        <div class="text-center py-4">
          <div class="text-muted">
            <i class="fas fa-comment-slash fa-2x mb-2 text-secondary opacity-50"></i>
            <h6 class="text-secondary mb-1">No Feedback Sent</h6>
            <small class="text-muted">No feedback has been sent for this renewal application yet.</small>
          </div>
        </div>
      {% endif %}
    </div>
  </section>

  <!-- Feedback Modal -->
  <div id="feedbackModal" class="global-modal" aria-labelledby="feedbackModalTitle" aria-modal="true" role="dialog">
    <div class="modal-container">
      <button type="button" class="btn-back" onclick="closeFeedbackModal()" aria-label="Close">
        <i class="fas fa-arrow-left"></i> Back
      </button>

      <div class="modal-section">
        <h2 class="form-title">Details</h2>
        <div class="form-info">
          <p><strong>Organization:</strong> Global Institute for Sustainable Technology and Innovation</p>
          <p><strong>File Name:</strong> <span id="file-name"></span></p>
          <p><strong>Form Type:</strong> <span id="form-type"></span></p>
          <p><strong>Form Status:</strong> <span id="form-status"></span></p>
        </div>

        <form id="feedback-form">
          <h2 class="form-title">Send a Feedback</h2>
          <div class="mb-3">
            <label for="subject" class="form-label">Subject</label>
            <input
              type="text"
              class="form-control"
              id="subject"
              name="subject"
              autocomplete="off"
            />
          </div>
          <div class="mb-4">
            <label for="message" class="form-label">Message Content</label>
            <textarea
              class="form-control"
              id="message"
              name="message"
              rows="8"
            ></textarea>
          </div>
          <div class="d-flex justify-content-end">
            <button type="submit" class="btn-send">Send Feedback</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Feedback Detail Modal -->
  <div id="feedbackDetailModal" class="global-modal feedback-detail-modal" aria-labelledby="feedbackDetailModalTitle" aria-modal="true" role="dialog">
    <div class="modal-container">
      <button type="button" class="btn-back" onclick="closeFeedbackDetailModal()" aria-label="Close">
        <i class="fas fa-arrow-left"></i> Back
      </button>

      <div class="modal-section">
        <div class="feedback-detail-header">
          <h2 class="form-title mb-0" id="feedback-detail-title">Feedback Detail</h2>
          <span class="feedback-badge" id="feedback-detail-badge">Sent</span>
        </div>
        
        <div class="feedback-metadata">
          <p><strong>Date:</strong> <span id="feedback-detail-date"></span></p>
          <p><strong>File:</strong> <span id="feedback-detail-file"></span></p>
          <p><strong>Form Type:</strong> <span id="feedback-detail-form-type"></span></p>
        </div>
        
        <div class="feedback-content">
          <h3 class="fs-6 fw-semibold mb-2" id="feedback-detail-subject"></h3>
          <p id="feedback-detail-message"></p>
        </div>
        
        <div class="feedback-reply-section" id="feedback-reply-section">
          <h3 class="fs-6 fw-semibold mb-3">Reply</h3>
          <div class="feedback-content">
            <h3 class="fs-6 fw-semibold mb-2" id="feedback-reply-subject"></h3>
            <p id="feedback-reply-message"></p>
            <div class="text-end text-muted mt-2" id="feedback-reply-date"></div>
          </div>
        </div>
        
        <div class="d-flex justify-content-end mt-3">
          <button type="button" class="btn btn-feedback" id="btn-reply-feedback">Reply to Feedback</button>
        </div>
      </div>
    </div>
  </div>
  <!-- File Preview Modal -->
  <div id="filePreviewModal" class="global-modal file-preview-modal" aria-labelledby="filePreviewModalTitle" aria-modal="true" role="dialog">
    <div class="modal-container modal-lg">
      <div class="modal-section">
        <div class="file-preview-header d-flex justify-content-between align-items-center mb-3">
          <h2 class="form-title mb-0" id="file-preview-title">File Preview</h2>
          <div class="d-flex align-items-center gap-2">
            <button type="button" class="btn btn-download" id="modal-download-btn" onclick="downloadCurrentFile()"><i class="fas fa-download"></i> Download</button>
            <button type="button" class="btn-close" onclick="closeFilePreviewModal()" aria-label="Close"></button>
          </div>
        </div>
        
        <div class="file-preview-content">
          <div id="file-preview-container" class="file-preview-container">
            <!-- File content will be loaded here -->
            <div class="text-center p-5" id="file-loading">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <p class="mt-3">Loading file preview...</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  {% include 'admin/modal/statusUpdateModal.html' %}
  {% include 'admin/modal/editFeedbackModal.html' %}
</main>

{% block extra_js %}
<!-- Load dependencies first without defer -->
<script src="{{ url_for('static', filename='js/common/dom-utils.js') }}?v={{ cache_version }}"></script>
<script src="{{ url_for('static', filename='js/common/file-status.js') }}?v={{ cache_version }}"></script>
<script src="{{ url_for('static', filename='js/common/file-preview.js') }}"></script>
<!-- Then load the main script with defer -->
<script src="{{ url_for('static', filename='js/admin/organizationrenewals.js') }}" defer></script>
{% endblock %}

{% endblock content %}